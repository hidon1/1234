<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>מחברת אישית - Firebase</title>
    <style>
      :root {
        --bg: #0f172a;
        --card: #111827;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --primary: #3b82f6;
        --primary-hover: #2563eb;
        --secondary: #374151;
        --danger: #ef4444;
        --success: #22c55e;
        --border: #1f2937;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0; background: var(--bg); color: var(--text);
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }

      .container { max-width: 900px; margin: 0 auto; padding: 24px; }
      .app-header { margin-bottom: 16px; }
      .card {
        background: var(--card); border: 1px solid var(--border); border-radius: 14px;
        padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      }
      .hidden { display: none; }

      .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
      .tab {
        border: 1px solid var(--border); background: transparent; color: var(--text); padding: 8px 12px;
        border-radius: 8px; cursor: pointer;
      }
      .tab.active { background: var(--secondary); }

      .form { display: none; }
      .form-visible { display: grid; gap: 10px; }
      label { display: grid; gap: 6px; }
      input, button, textarea, select {
        font: inherit; border-radius: 8px; border: 1px solid var(--border);
      }
      input, textarea, select {
        background: #0b1220; color: var(--text); padding: 10px; width: 100%;
      }
      textarea { min-height: 90px; resize: vertical; }
      button { color: var(--text); background: var(--secondary); padding: 8px 12px; cursor: pointer; }
      button.primary { background: var(--primary); border-color: var(--primary); }
      button.primary:hover { background: var(--primary-hover); }
      button.secondary { background: var(--secondary); }
      button.danger { background: var(--danger); border-color: var(--danger); }

      .error { color: #fca5a5; min-height: 1.2em; }
      .hint { color: var(--muted); }
      .muted { color: var(--muted); }

      .user-bar {
        display: flex; align-items: center; justify-content: space-between;
        background: #0b1220; border: 1px solid var(--border); border-radius: 10px; padding: 10px;
        margin-bottom: 12px;
      }
      .user-email { font-weight: 600; }
      .actions { display: flex; gap: 8px; }

      .rows-controls { margin: 8px 0 12px; }
      .rows-container { display: grid; gap: 10px; }
      .row {
        display: grid; gap: 8px; padding: 10px; border: 1px solid var(--border); border-radius: 10px;
        background: #0b1220;
      }
      .row .row-actions { display: flex; gap: 8px; justify-content: flex-start; }

      .entries-list { display: grid; gap: 10px; margin-top: 10px; }
      .entry-item {
        display: grid; gap: 6px; padding: 10px; border: 1px solid var(--border); border-radius: 10px;
        background: #0b1220;
      }
      .entry-header {
        display: flex; align-items: center; justify-content: space-between;
      }
      .entry-title { font-weight: 700; }
      .entry-meta { color: var(--muted); font-size: 0.9em; }
      .entry-content { white-space: pre-wrap; }
      .entry-image {
        max-width: 100%;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0b1220;
      }
      .image-preview {
        max-width: 100%;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      .footer { text-align: center; margin-top: 18px; color: var(--muted); }
    </style>
  </head>
  <body>
    <main class="container">
      <header class="app-header">
        <h1>מחברת אישית</h1>
      </header>

      <!-- מסך התחברות/הרשמה -->
      <section id="auth-view" class="card">
        <div class="tabs">
          <button id="tab-login" class="tab active">התחברות</button>
          <button id="tab-register" class="tab">הרשמה</button>
        </div>

        <form id="login-form" class="form form-visible" autocomplete="on">
          <label>
            אימייל
            <input type="email" id="login-email" placeholder="example@domain.com" required />
          </label>
          <label>
            סיסמה
            <input type="password" id="login-password" placeholder="סיסמה" required />
          </label>
          <button type="submit" class="primary">התחבר</button>
          <p class="hint">אין לך משתמש? עבור ללשונית "הרשמה".</p>
          <p id="login-error" class="error" role="alert"></p>
        </form>

        <form id="register-form" class="form" autocomplete="on">
          <label>
            אימייל
            <input type="email" id="register-email" placeholder="example@domain.com" required />
          </label>
          <label>
            סיסמה
            <input type="password" id="register-password" placeholder="סיסמה (לפחות 6 תווים)" minlength="6" required />
          </label>
          <button type="submit" class="primary">צור משתמש</button>
          <p id="register-error" class="error" role="alert"></p>
        </form>
      </section>

      <!-- מסך האפליקציה -->
      <section id="app-view" class="card hidden">
        <div class="user-bar">
          <div>
            <span id="user-email" class="user-email"></span>
          </div>
          <div class="actions">
            <button id="signout-btn" class="secondary">התנתק</button>
          </div>
        </div>

        <h2>הוספת שורות מידע</h2>
        <div class="rows-controls">
          <button id="add-row-btn" class="primary">הוסף שורה</button>
        </div>

        <div id="rows-container" class="rows-container">
          <!-- כאן יתווספו שורות קלט -->
        </div>

        <h2>השורות השמורות שלך</h2>
        <div id="entries-list" class="entries-list">
          <!-- כאן יוצגו הרשומות מה-DB בזמן אמת -->
        </div>
        <p id="entries-status" class="muted"></p>
      </section>

      <footer class="footer">
        <p>האתר סטטי ומתחבר ל-Firebase (Auth + Firestore + Storage). ניתן לפרוס ב-GitHub Pages.</p>
      </footer>
    </main>

    <!-- קוד האפליקציה (מודול ES) -->
    <script type="module">
      // טעינת Firebase SDK (מודולים) דרך CDN
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth, onAuthStateChanged,
        signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore, collection, addDoc, doc, setDoc, deleteDoc,
        onSnapshot, query, orderBy, serverTimestamp
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getStorage, ref, uploadBytes, getDownloadURL, deleteObject
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

      // עדכן כאן את הקונפיגורציה לאחר יצירת אפליקציית Web ב-Firebase Console
      const firebaseConfig = {
        apiKey: "PASTE_API_KEY_HERE",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com", // חשוב עבור העלאת תמונות
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID",
        // databaseURL: "https://YOUR_PROJECT.firebaseio.com"
      };

      // אתחול Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // אלמנטים מה-DOM
      const authView = document.getElementById("auth-view");
      const appView = document.getElementById("app-view");

      const tabLogin = document.getElementById("tab-login");
      const tabRegister = document.getElementById("tab-register");
      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const loginEmail = document.getElementById("login-email");
      const loginPassword = document.getElementById("login-password");
      const registerEmail = document.getElementById("register-email");
      const registerPassword = document.getElementById("register-password");
      const loginError = document.getElementById("login-error");
      const registerError = document.getElementById("register-error");

      const userEmailEl = document.getElementById("user-email");
      const signoutBtn = document.getElementById("signout-btn");

      const addRowBtn = document.getElementById("add-row-btn");
      const rowsContainer = document.getElementById("rows-container");
      const entriesList = document.getElementById("entries-list");
      const entriesStatus = document.getElementById("entries-status");

      let entriesUnsub = null; // ביטול מאזין Firestore

      // החלפת לשוניות (התחברות/הרשמה)
      tabLogin.addEventListener("click", () => {
        tabLogin.classList.add("active");
        tabRegister.classList.remove("active");
        loginForm.classList.add("form-visible");
        registerForm.classList.remove("form-visible");
        loginError.textContent = "";
      });
      tabRegister.addEventListener("click", () => {
        tabRegister.classList.add("active");
        tabLogin.classList.remove("active");
        registerForm.classList.add("form-visible");
        loginForm.classList.remove("form-visible");
        registerError.textContent = "";
      });

      // התחברות
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        loginError.textContent = "";
        try {
          await signInWithEmailAndPassword(auth, loginEmail.value.trim(), loginPassword.value);
        } catch (err) {
          loginError.textContent = mapAuthError(err);
        }
      });

      // הרשמה
      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        registerError.textContent = "";
        try {
          await createUserWithEmailAndPassword(auth, registerEmail.value.trim(), registerPassword.value);
        } catch (err) {
          registerError.textContent = mapAuthError(err);
        }
      });

      // התנתקות
      signoutBtn.addEventListener("click", async () => {
        await signOut(auth);
      });

      // מצב התחברות
      onAuthStateChanged(auth, (user) => {
        if (user) {
          userEmailEl.textContent = `מחובר כ: ${user.email}`;
          authView.classList.add("hidden");
          appView.classList.remove("hidden");
          startEntriesListener(user.uid);
        } else {
          userEmailEl.textContent = "";
          appView.classList.add("hidden");
          authView.classList.remove("hidden");
          stopEntriesListener();
          clearUI();
        }
      });

      // הוספת שורה חדשה: סוג (טקסט/תמונה), כותרת, תוכן/קובץ
      addRowBtn.addEventListener("click", () => {
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <label>
            סוג שורה
            <select class="row-type">
              <option value="text">טקסט</option>
              <option value="image">תמונה</option>
            </select>
          </label>

          <label>
            כותרת
            <input type="text" class="row-title" placeholder="הקלד כותרת" />
          </label>

          <label class="text-area-wrapper">
            תוכן
            <textarea class="row-content" placeholder="הקלד תוכן"></textarea>
          </label>

          <label class="file-input-wrapper hidden">
            בחר תמונה
            <input type="file" class="row-file" accept="image/*" />
          </label>
          <img class="image-preview hidden" alt="תצוגה מקדימה"/>

          <div class="row-actions">
            <button class="primary save-row-btn">שמור שורה</button>
            <button class="secondary clear-row-btn">נקה</button>
            <button class="danger remove-row-btn">הסר</button>
          </div>
        `;

        const typeSel = row.querySelector(".row-type");
        const titleEl = row.querySelector(".row-title");
        const contentEl = row.querySelector(".row-content");
        const fileWrapper = row.querySelector(".file-input-wrapper");
        const fileEl = row.querySelector(".row-file");
        const previewImg = row.querySelector(".image-preview");

        // החלפת מצב לפי סוג
        const updateMode = () => {
          const t = typeSel.value;
          if (t === "text") {
            contentEl.parentElement.classList.remove("hidden");
            fileWrapper.classList.add("hidden");
            previewImg.classList.add("hidden");
          } else {
            contentEl.parentElement.classList.add("hidden");
            fileWrapper.classList.remove("hidden");
            if (!fileEl.files?.length) previewImg.classList.add("hidden");
          }
        };
        typeSel.addEventListener("change", updateMode);
        updateMode();

        // תצוגה מקדימה לתמונה
        fileEl.addEventListener("change", () => {
          const file = fileEl.files?.[0];
          if (!file) {
            previewImg.classList.add("hidden");
            previewImg.src = "";
            return;
          }
          const reader = new FileReader();
          reader.onload = () => {
            previewImg.src = reader.result;
            previewImg.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        });

        const saveBtn = row.querySelector(".save-row-btn");
        const clearBtn = row.querySelector(".clear-row-btn");
        const removeBtn = row.querySelector(".remove-row-btn");

        saveBtn.addEventListener("click", async () => {
          if (!auth.currentUser) return alert("יש להתחבר כדי לשמור.");
          const type = typeSel.value;
          const title = titleEl.value.trim();

          try {
            const uid = auth.currentUser.uid;

            if (type === "text") {
              const content = contentEl.value.trim();
              if (!title && !content) return alert("מלא לפחות כותרת או תוכן.");
              await addDoc(collection(db, "users", uid, "entries"), {
                type: "text",
                title,
                content,
                createdAt: serverTimestamp(),
              });
              titleEl.value = "";
              contentEl.value = "";
              toast("השורה (טקסט) נשמרה בהצלחה.");
            } else {
              const file = fileEl.files?.[0];
              if (!file) return alert("בחר תמונה לשמירה.");
              const MAX = 10 * 1024 * 1024; // 10MB
              if (file.size > MAX) return alert("הקובץ גדול מדי (מעל 10MB).");

              // צור מסמך ואז העלה תמונה וצרף URL + נתיב
              const docRef = await addDoc(collection(db, "users", uid, "entries"), {
                type: "image",
                title,
                createdAt: serverTimestamp(),
              });

              const safeName = `${Date.now()}_${file.name.replaceAll(" ", "_")}`;
              const storagePath = `users/${uid}/entries/${docRef.id}/${safeName}`;
              const storageRef = ref(storage, storagePath);
              await uploadBytes(storageRef, file);
              const url = await getDownloadURL(storageRef);

              await setDoc(docRef, { imageUrl: url, storagePath }, { merge: true });

              // ניקוי
              titleEl.value = "";
              fileEl.value = "";
              previewImg.src = "";
              previewImg.classList.add("hidden");
              toast("השורה (תמונה) נשמרה בהצלחה.");
            }
          } catch (err) {
            console.error(err);
            alert("שמירה נכשלה. נסה שוב.");
          }
        });

        clearBtn.addEventListener("click", () => {
          titleEl.value = "";
          contentEl.value = "";
          fileEl.value = "";
          previewImg.src = "";
          previewImg.classList.add("hidden");
        });

        removeBtn.addEventListener("click", () => {
          rowsContainer.removeChild(row);
        });

        rowsContainer.prepend(row);
      });

      // מאזין לרשומות של המשתמש (ב��מן אמת)
      function startEntriesListener(uid) {
        stopEntriesListener();
        const q = query(collection(db, "users", uid, "entries"), orderBy("createdAt", "desc"));
        entriesUnsub = onSnapshot(q, (snap) => {
          entriesList.innerHTML = "";
          if (snap.empty) {
            entriesStatus.textContent = "אין רשומות שמורות עדיין.";
            return;
          }
          entriesStatus.textContent = `סה״כ ${snap.size} רשומות.`;
          snap.forEach((docSnap) => {
            const data = docSnap.data();
            const item = document.createElement("div");
            item.className = "entry-item";
            const ts = data.createdAt?.toDate ? data.createdAt.toDate() : null;
            const when = ts ? ts.toLocaleString("he-IL") : "—";

            const title = escapeHtml(data.title || "(ללא כותרת)");
            const isImage = data.type === "image" && data.imageUrl;

            item.innerHTML = `
              <div class="entry-header">
                <div class="entry-title">${title}</div>
                <div class="entry-meta">${when}</div>
              </div>
              <div class="entry-body"></div>
              <div class="entry-actions" style="margin-top:6px;">
                <button class="danger delete-entry-btn">מחק</button>
              </div>
            `;

            const body = item.querySelector(".entry-body");
            if (isImage) {
              const img = document.createElement("img");
              img.className = "entry-image";
              img.src = data.imageUrl;
              img.alt = data.title || "תמונה";
              body.appendChild(img);
            } else {
              const content = document.createElement("div");
              content.className = "entry-content";
              content.innerHTML = escapeHtml(data.content || "");
              body.appendChild(content);
            }

            const delBtn = item.querySelector(".delete-entry-btn");
            delBtn.addEventListener("click", async () => {
              if (!confirm("למחוק את הרשומה?")) return;
              try {
                // מחיקת מסמך
                await deleteDoc(doc(db, "users", uid, "entries", docSnap.id));
                // אם יש קובץ תמונה – מחיקה גם מה-Storage
                if (data.type === "image" && data.storagePath) {
                  try {
                    await deleteObject(ref(storage, data.storagePath));
                  } catch (e) {
                    console.warn("מחיקת קובץ מה-Storage נכשלה:", e);
                  }
                }
              } catch (err) {
                console.error(err);
                alert("מחיקה נכשלה.");
              }
            });

            entriesList.appendChild(item);
          });
        }, (err) => {
          console.error(err);
          entriesStatus.textContent = "שגיאה בטעינת הרשומות.";
        });
      }

      function stopEntriesListener() {
        if (entriesUnsub) {
          entriesUnsub();
          entriesUnsub = null;
        }
      }

      function clearUI() {
        rowsContainer.innerHTML = "";
        entriesList.innerHTML = "";
        entriesStatus.textContent = "";
        loginForm.reset();
        registerForm.reset();
        loginError.textContent = "";
        registerError.textContent = "";
      }

      // הודעה קצרה (Toast) בסיסית
      function toast(msg) {
        const el = document.createElement("div");
        el.textContent = msg;
        el.style.position = "fixed";
        el.style.bottom = "16px";
        el.style.right = "16px";
        el.style.zIndex = "9999";
        el.style.background = "#0b1220";
        el.style.color = "#e5e7eb";
        el.style.border = "1px solid #1f2937";
        el.style.borderRadius = "8px";
        el.style.padding = "8px 12px";
        el.style.boxShadow = "0 6px 16px rgba(0,0,0,.35)";
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 2500);
      }

      // מיפוי שגיאות Auth לידידותיות
      function mapAuthError(err) {
        const code = err?.code || "";
        if (code.includes("invalid-email")) return "אימייל לא תקין.";
        if (code.includes("user-not-found")) return "המשתמש לא נמצא.";
        if (code.includes("wrong-password")) return "סיסמה שגויה.";
        if (code.includes("email-already-in-use")) return "האימייל כבר בשימוש.";
        if (code.includes("weak-password")) return "סיסמה חלשה (לפחות 6 תווים).";
        return "שגיאה בהתחברות. נסה שוב.";
      }

      // הגנה בסיסית מטקסט HTML לא בטוח
      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
    </script>
  </body>
</html>