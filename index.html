<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניטור יין - משופרת</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&family=Playfair+Display:wght@400;700&family=Noto+Sans+Hebrew:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- הוספת ספריות ל-PDF עם תמיכה בעברית -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script> <!-- For advanced graphs -->
    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore-compat.js"></script>

    <script>
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCRXyTlTe9u9bjvL6Y3eUnztesa27hkWaY",
        authDomain: "project-2118807878810546832.firebaseapp.com",
        projectId: "project-2118807878810546832",
        storageBucket: "project-2118807878810546832.firebasestorage.app",
        messagingSenderId: "519860367831",
        appId: "1:519860367831:web:488f364c2e51d27b6a5b92",
        measurementId: "G-F5NEQP6X3Q"
      };

      // Initialize Firebase (run once)
      const app = firebase.initializeApp(firebaseConfig);
      if (firebase.analytics) {
        try { firebase.analytics(); } catch (e) { console.warn('Analytics init failed', e); }
      }
      const auth = firebase.auth();
      const db = firebase.firestore();

      // Expose globals for non-module scripts
      window.firebaseApp = app;
      window.auth = auth;
      window.db = db;

      console.log('Firebase (compat) initialized:', firebase.app().options);
    </script>
    <style>
        :root {
            --primary-color: #8B0000;
            --secondary-color: #A52A2A;
            --accent-color: #FFD700;
            --background-color: #FFF8E1;
            --card-background: #ffffff;
            --text-color: #333;
            --light-text-color: #666;
            --border-color: #E0E0E0;
            --shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 15px;
            --animation-speed: 0.4s;
            --graph-line-color: #DAA520;
            --graph-area-color: rgba(218, 165, 32, 0.2);
            --graph-point-color: #B8860B;
            --graph-average-color: #6B8E23;
            --top-section-background: linear-gradient(135deg, #FFF8E1, #F5F5DC);
            --top-section-border: #D4C6B1;
            --dark-background-color: #2F4F4F;
            --dark-card-background: #36454F;
            --dark-text-color: #F5DEB3;
            --dark-light-text-color: #C0C0C0;
            --dark-border-color: #556B2F;
            --dark-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
            --dark-primary-color: #B80000;
            --dark-secondary-color: #8B0000;
            --dark-accent-color: #ADFF2F;
            --dark-graph-line-color: #FFD700;
            --dark-graph-area-color: rgba(255, 215, 0, 0.2);
            --font-size-base: 16px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans Hebrew', 'Heebo', sans-serif;
            font-weight: 400;
            font-size: var(--font-size-base);
            margin: 0;
            padding: 0;
            padding-bottom: 180px;
            background: var(--top-section-background);
            color: var(--text-color);
            direction: rtl;
            line-height: 1.6;
            overflow-x: hidden;
            transition: all var(--animation-speed);
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        body.dark-mode {
            background: linear-gradient(135deg, var(--dark-background-color), #1a1a1a);
            color: var(--dark-text-color);
        }

        h1, h2 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: calc(var(--font-size-base) * 1.5);
            color: var(--primary-color);
            margin-bottom: 20px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            transition: color var(--animation-speed);
        }

        h3, h4 {
            font-family: 'Noto Sans Hebrew', 'Heebo', sans-serif;
            font-weight: 700;
            font-size: calc(var(--font-size-base) * 1.2);
            color: var(--secondary-color);
            margin-bottom: 15px;
        }

        p, span, div {
            font-family: 'Noto Sans Hebrew', 'Heebo', sans-serif;
            font-weight: 300;
        }

        .top-section-wrapper {
            background: var(--top-section-background);
            padding-top: 5px;
            padding-left: 25px;
            padding-right: 25px;
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: all var(--animation-speed);
            border-bottom: 1px solid var(--top-section-border);
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        body.dark-mode .top-section-wrapper {
            background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
            border-color: var(--dark-border-color);
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            animation: fadeInUp 0.5s ease-out;
            transition: all var(--animation-speed);
            position: relative;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body.dark-mode .container {
            background-color: var(--dark-card-background);
        }

        .project-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            gap: 5px;
            padding-top: 5px;
        }

        #currentProjectName {
            font-family: 'Playfair Display', serif;
            font-size: calc(var(--font-size-base) * 1.5);
            color: var(--primary-color);
            font-weight: 700;
            cursor: pointer;
            transition: color var(--animation-speed);
            margin: 0;
            text-align: center;
        }

        #currentProjectName:hover {
            text-decoration: underline;
            color: var(--secondary-color);
        }

        #editProjectNameInput {
            font-family: 'Noto Sans Hebrew', sans-serif;
            font-size: calc(var(--font-size-base) * 1.2);
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-background);
            color: var(--text-color);
            transition: all var(--animation-speed);
            text-align: center;
            max-width: 80%;
        }

        .stage-nav-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            margin-bottom: 20px;
            padding: 10px;
            background: linear-gradient(135deg, #F8F0E3, #E6D7C3);
            border-radius: var(--border-radius);
            transition: all var(--animation-speed);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        body.dark-mode .stage-nav-container {
            background: linear-gradient(135deg, var(--dark-card-background), #3a3a3a);
        }

        .stage-nav-button {
            background-color: var(--light-text-color);
            color: white;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: calc(var(--font-size-base) * 0.9);
            font-weight: 700;
            transition: all 0.3s ease, transform 0.2s ease;
            min-width: 100px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stage-nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .stage-nav-button:hover::before {
            left: 100%;
        }

        .stage-nav-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .stage-nav-button.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        body.dark-mode .stage-nav-button {
            background-color: var(--dark-secondary-color);
            border-color: var(--dark-border-color);
            color: var(--dark-text-color);
        }

        body.dark-mode .stage-nav-button.active {
            background-color: var(--dark-primary-color);
            border-color: var(--dark-primary-color);
        }

        body.dark-mode .stage-nav-button:hover {
            background-color: var(--dark-primary-color);
        }

        .wine-icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 15px;
        }

        .wine-icon-container img {
            width: 70px;
            height: auto;
            vertical-align: middle;
            transition: transform 0.3s ease;
        }

        .wine-icon-container img:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .dashboard-section {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.2);
            padding: 10px 15px;
            color: white;
            text-align: center;
            transition: all var(--animation-speed);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .dashboard-section h2 {
            text-align: center;
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 5px;
            font-family: 'Playfair Display', serif;
            font-size: calc(var(--font-size-base) * 1.2);
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            transition: color var(--animation-speed);
        }

        .dashboard-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 1000px;
        }

        .dashboard-item {
            background-color: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius);
            padding: 8px 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
            flex: 1;
            min-width: 70px;
            max-width: 100px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }

        .dashboard-item:hover {
            transform: translateY(-5px) scale(1.02);
            background-color: rgba(255, 255, 255, 0.25);
        }

        .dashboard-item h3 {
            margin-top: 0;
            margin-bottom: 2px;
            color: var(--accent-color);
            font-family: 'Noto Sans Hebrew', sans-serif;
            font-size: calc(var(--font-size-base) * 0.7);
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color var(--animation-speed);
        }

        .dashboard-item p {
            font-size: calc(var(--font-size-base) * 1);
            font-weight: 700;
            color: white;
            margin: 0;
            font-family: 'Playfair Display', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        body.dark-mode .dashboard-item h3 {
            color: var(--dark-text-color);
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
            padding-top: 20px;
        }

        .input-group {
            background: linear-gradient(135deg, #fdfdfd, #f0f0f0);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, all var(--animation-speed);
        }

        .input-group:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .input-group {
            background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
            border-color: var(--dark-border-color);
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--light-text-color);
            font-size: calc(var(--font-size-base) * 1);
            transition: color var(--animation-speed);
        }

        .input-group input[type="number"], .input-group input[type="text"], .input-group select, .input-group textarea {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: calc(var(--font-size-base) * 1);
            color: var(--text-color);
            transition: all 0.3s ease, background-color var(--animation-speed), color var(--animation-speed);
            background-color: var(--card-background);
        }

        body.dark-mode .input-group input[type="number"], body.dark-mode .input-group input[type="text"], body.dark-mode .input-group select, body.dark-mode .input-group textarea {
            background-color: var(--dark-card-background);
            color: var(--dark-text-color);
            border-color: var(--dark-border-color);
        }

        .input-group input[type="number"]:focus, .input-group input[type="text"]:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2);
        }

        .input-group button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: calc(var(--font-size-base) * 1);
            font-weight: 700;
            transition: all 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            align-self: flex-end;
        }

        .input-group button:hover {
            background: linear-gradient(135deg, var(--secondary-color), #8B0000);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .graph-container {
            flex-grow: 1;
            height: 40px;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin: 0 20px;
            position: relative;
            overflow: hidden;
            border: 1px solid #ddd;
            transition: background-color var(--animation-speed), border-color var(--animation-speed);
        }

        .graph-bar {
            height: 100%;
            position: absolute;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: calc(var(--font-size-base) * 0.9);
            font-weight: 700;
            transition: all var(--animation-speed) ease-out;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
        }

        .graph-bar.positive {
            background: linear-gradient(90deg, #4CAF50, #66BB6A);
        }

        .graph-bar.negative {
            background: linear-gradient(90deg, #F44336, #E57373);
        }

        .graph-scale {
            position: absolute;
            height: 100%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px;
            font-size: calc(var(--font-size-base) * 0.7);
            color: #888;
            z-index: 1;
            transition: color var(--animation-speed);
        }

        .graph-scale span {
            min-width: unset;
            font-weight: normal;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            animation: fadeInModal 0.3s ease-out;
        }

        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: linear-gradient(135deg, var(--card-background), #f9f9f9);
            margin: auto;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 80%;
            max-width: 1000px;
            animation: slideInModal 0.4s ease-out;
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            transition: all var(--animation-speed);
        }

        @keyframes slideInModal {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        body.dark-mode .modal-content {
            background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
        }

        .close-button {
            color: #aaa;
            float: left;
            font-size: calc(var(--font-size-base) * 1.8);
            font-weight: bold;
            transition: color 0.3s ease;
            position: absolute;
            top: 10px;
            left: 20px;
        }

        .close-button:hover, .close-button:focus {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h3 {
            text-align: center;
            color: var(--primary-color);
            font-family: 'Playfair Display', serif;
            font-size: calc(var(--font-size-base) * 1.5);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            transition: color var(--animation-speed);
        }

        .modal-graph-container {
            width: 100%;
            height: 350px;
            margin: 20px auto 30px auto;
            background-color: #f0f0f0;
            border-radius: 8px;
            border: 1px solid #ddd;
            position: relative;
            overflow: hidden;
            transition: background-color var(--animation-speed), border-color var(--animation-speed);
            display: flex;
            justify-content: space-between;
        }

        body.dark-mode .modal-graph-container {
            background-color: var(--dark-card-background);
            border-color: var(--dark-border-color);
        }

        .modal-graph-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .modal-graph-line-path {
            fill: none;
            stroke: var(--graph-line-color);
            stroke-width: 3;
            transition: stroke-dasharray 1s ease-out;
        }

        .modal-graph-area-path {
            fill: var(--graph-area-color);
            opacity: 0.8;
            transition: fill 0.3s ease-out;
        }

        .modal-graph-point {
            fill: var(--graph-point-color);
            stroke: #fff;
            stroke-width: 2;
            cursor: pointer;
            transition: r 0.2s ease-out, fill 0.3s ease-out;
        }

        .modal-graph-point:hover {
            r: 7;
        }

        .modal-graph-label-x {
            font-size: calc(var(--font-size-base) * 0.6);
            fill: #888;
            text-anchor: middle;
            transition: fill var(--animation-speed);
        }

        .modal-graph-label-y {
            font-size: calc(var(--font-size-base) * 0.6);
            fill: #888;
            text-anchor: end;
            transition: fill var(--animation-speed);
        }

        .modal-graph-grid-line {
            stroke: #ccc;
            stroke-dasharray: 2,2;
            stroke-width: 0.5;
            transition: stroke var(--animation-speed);
        }

        .modal-graph-average-line {
            stroke: var(--graph-average-color);
            stroke-dasharray: 4, 4;
            stroke-width: 2;
        }

        .modal-graph-average-label {
            fill: var(--graph-average-color);
            font-size: calc(var(--font-size-base) * 0.6);
            font-weight: bold;
            text-anchor: start;
        }

        .graph-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .graph-controls button {
            background: linear-gradient(135deg, var(--accent-color), #FFD700);
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: calc(var(--font-size-base) * 0.8);
            transition: background 0.3s ease;
        }

        .graph-controls button:hover {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .history-list {
            list-style-type: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            direction: rtl;
            margin-top: 20px;
        }

        .history-list li {
            background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: calc(var(--font-size-base) * 1);
            color: var(--text-color);
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
            position: relative;
            transition: all var(--animation-speed);
        }

        body.dark-mode .history-list li {
            background: linear-gradient(135deg, #3a3a5e, #2a2a2a);
            border-color: var(--dark-border-color);
            color: var(--dark-text-color);
        }

        .history-list li strong {
            color: var(--secondary-color);
            font-size: calc(var(--font-size-base) * 1.1);
            flex-basis: 30%;
            text-align: right;
            transition: color var(--animation-speed);
        }

        .history-list li span.timestamp {
            color: var(--light-text-color);
            font-size: calc(var(--font-size-base) * 0.8);
            flex-basis: 60%;
            text-align: left;
            transition: color var(--animation-speed);
        }

        .history-list li .undo-button {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: calc(var(--font-size-base) * 0.7);
            transition: background 0.3s ease;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .history-list li .undo-button:hover {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
        }

        .hamburger-menu-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            z-index: 1100;
            box-shadow: var(--shadow);
            transition: all 0.3s ease, transform 0.2s ease;
        }

        .hamburger-menu-btn:hover {
            background: linear-gradient(135deg, var(--secondary-color), #8B0000);
            transform: scale(1.05);
        }

        .hamburger-menu-btn span {
            display: block;
            width: 25px;
            height: 3px;
            background-color: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-menu-btn.open span:nth-child(1) {
            transform: translateY(9px) rotate(45deg);
        }

        .hamburger-menu-btn.open span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu-btn.open span:nth-child(3) {
            transform: translateY(-9px) rotate(-45deg);
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background: linear-gradient(135deg, var(--card-background), #f0f0f0);
            box-shadow: -6px 0 16px rgba(0,0,0,0.2);
            z-index: 1050;
            transition: right 0.4s ease-out;
            padding-top: 80px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
            overflow-y: auto; /* הוספתי גלילה אנכית כדי לאפשר גישה לכל הפריטים */
        }

        body.dark-mode .sidebar {
            background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
            box-shadow: -6px 0 16px rgba(0, 0, 0, 0.5);
            border-color: var(--dark-border-color);
        }

        .sidebar.open {
            right: 0;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1040;
        }

        .sidebar.open + .sidebar-overlay {
            display: block;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li {
            margin-bottom: 5px;
        }

        .sidebar ul li a, .sidebar ul li button {
            display: block;
            padding: 15px 25px;
            color: var(--text-color);
            text-decoration: none;
            font-size: calc(var(--font-size-base) * 1);
            font-weight: 700;
            transition: all 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            text-align: right;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
        }

        body.dark-mode .sidebar ul li a, body.dark-mode .sidebar ul li button {
            color: var(--dark-text-color);
        }

        .sidebar ul li a:hover, .sidebar ul li button:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        body.dark-mode .sidebar ul li a:hover, body.dark-mode .sidebar ul li button:hover {
            background: linear-gradient(135deg, var(--dark-secondary-color), var(--dark-primary-color));
            color: white;
        }

        .sidebar .divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 15px 20px;
            transition: background-color var(--animation-speed);
        }

        body.dark-mode .sidebar .divider {
            background-color: var(--dark-border-color);
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 20px 25px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: border-color var(--animation-speed);
        }

        body.dark-mode .sidebar-footer {
            border-color: var(--dark-border-color);
        }

        .theme-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--light-text-color);
            transition: color var(--animation-speed);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        body.dark-mode .slider {
            background-color: #555;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        body.dark-mode input:checked + .slider {
            background-color: var(--dark-primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .zoom-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .zoom-controls button {
            background: linear-gradient(135deg, var(--accent-color), #FFD700);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .zoom-controls button:hover {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            transform: scale(1.1);
        }
        .project-modal-content {
            padding: 30px;
            text-align: right;
        }

        .project-modal-content h3 {
            text-align: center;
        }

        .project-filter {
            margin-bottom: 20px;
            text-align: center;
        }

        .project-filter select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-background);
            color: var(--text-color);
            font-size: calc(var(--font-size-base) * 0.9);
        }

        body.dark-mode .project-filter select {
            background-color: var(--dark-card-background);
            color: var(--dark-text-color);
            border-color: var(--dark-border-color);
        }

        .project-list {
            list-style: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .project-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: calc(var(--font-size-base) * 1);
            position: relative;
        }

        body.dark-mode .project-list li {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            color: var(--dark-text-color);
        }

        .project-list li:hover {
            background: linear-gradient(135deg, #e0e0e0, #d0d0d0);
            transform: translateY(-2px);
        }

        body.dark-mode .project-list li:hover {
            background: linear-gradient(135deg, #3a3a3a, #2a3a3a);
        }

        .project-list li.active-project {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            font-weight: 700;
        }

        .project-list li.active-project:hover {
            background: linear-gradient(135deg, var(--primary-color), #8B0000);
        }

        .project-list li.closed {
            opacity: 0.6;
            background: linear-gradient(135deg, #ccc, #aaa);
        }

        .project-list li.closed::after {
            content: 'סגור';
            position: absolute;
            top: 5px;
            left: 5px;
            background: #f44336;
            color: white;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: calc(var(--font-size-base) * 0.7);
        }

        .project-actions {
            display: flex;
            gap: 5px;
        }

        .project-actions button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            margin-right: 10px;
            font-size: calc(var(--font-size-base) * 0.9);
            transition: color 0.2s ease;
        }

        .project-actions button:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        .project-actions button.delete {
            color: #f44336;
        }

        .project-actions button.delete:hover {
            color: #d32f2f;
        }

        .project-actions button.close-project {
            color: #ff9800;
        }

        .project-actions button.close-project:hover {
            color: #f57c00;
        }

        .add-project-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: calc(var(--font-size-base) * 1);
            font-weight: 700;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .add-project-btn:hover {
            background: linear-gradient(135deg, var(--secondary-color), #8B0000);
            transform: translateY(-2px);
        }

        .finance-modal-content {
            padding: 30px;
            text-align: right;
        }

        .finance-modal-content h3 {
            text-align: center;
        }

        .finance-input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: linear-gradient(135deg, #fcfcfc, #f0f0f0);
            transition: all var(--animation-speed);
        }

        body.dark-mode .finance-input-group {
            background: linear-gradient(135deg, #242424, #1a1a1a);
            border-color: #444;
        }

        .finance-input-group label {
            font-weight: 700;
            color: var(--light-text-color);
            transition: color var(--animation-speed);
        }

        .finance-input-group input, .finance-input-group textarea {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: calc(var(--font-size-base) * 1);
            background-color: var(--card-background);
            color: var(--text-color);
            transition: all var(--animation-speed);
        }

        body.dark-mode .finance-input-group input, body.dark-mode .finance-input-group textarea {
            background-color: var(--dark-card-background);
            color: var(--dark-text-color);
            border-color: var(--dark-border-color);
        }

        .finance-input-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .finance-input-buttons button {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: calc(var(--font-size-base) * 1);
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .finance-input-buttons .add-income-btn {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
        }

        .finance-input-buttons .add-income-btn:hover {
            background: linear-gradient(135deg, #43a047, #4CAF50);
        }

        .finance-input-buttons .add-expense-btn {
            background: linear-gradient(135deg, #F44336, #E57373);
        }

        .finance-input-buttons .add-expense-btn:hover {
            background: linear-gradient(135deg, #d32f2f, #F44336);
        }

        .finance-list {
            list-style: none;
            padding: 0;
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .finance-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: calc(var(--font-size-base) * 1);
            transition: all var(--animation-speed);
        }

        body.dark-mode .finance-list li {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border-color: #444;
            color: var(--dark-text-color);
        }

        .finance-item-details {
            flex-grow: 1;
        }

        .finance-item-details .amount {
            font-weight: 700;
        }

        .finance-item-details .amount.income {
            color: #4CAF50;
        }

        .finance-item-details .amount.expense {
            color: #F44336;
        }

        body.dark-mode .finance-item-details .amount.income {
            color: #8BC34A;
        }

        body.dark-mode .finance-item-details .amount.expense {
            color: #EF5350;
        }

        .finance-item-actions button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            margin-right: 8px;
            font-size: calc(var(--font-size-base) * 0.8);
            transition: color 0.2s ease;
        }

        .finance-item-actions button:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        .finance-item-actions button.delete {
            color: #f44336;
        }

        .finance-item-actions button.delete:hover {
            color: #d32f2f;
        }

        .finance-balance-total {
            text-align: center;
            font-size: calc(var(--font-size-base) * 1.2);
            font-weight: 700;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            color: var(--primary-color);
            transition: all var(--animation-speed);
        }

        body.dark-mode .finance-balance-total {
            border-color: var(--dark-border-color);
            color: var(--dark-primary-color);
        }

        .finance-balance-total span {
            color: var(--secondary-color);
            margin-right: 5px;
            transition: color var(--animation-speed);
        }

        .finance-balance-total span.positive {
            color: #4CAF50;
        }

        .finance-balance-total span.negative {
            color: #F44336;
        }

        body.dark-mode .finance-balance-total span.positive {
            color: #8BC34A;
        }

        body.dark-mode .finance-balance-total span.negative {
            color: #EF5350;
        }

        .current-project-finance-report-modal .modal-content {
            max-width: 600px;
        }

        .current-project-finance-report-modal h3 {
            margin-bottom: 30px;
        }

        .current-project-finance-report-summary {
            margin-bottom: 20px;
            font-size: calc(var(--font-size-base) * 1);
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            transition: border-color var(--animation-speed);
        }

        body.dark-mode .current-project-finance-report-summary {
            border-color: var(--dark-border-color);
        }

        .current-project-finance-report-summary div {
            padding: 5px 0;
            font-weight: 700;
        }

        .current-project-finance-report-summary .total-income {
            color: #4CAF50;
        }

        .current-project-finance-report-summary .total-expense {
            color: #F44336;
        }

        .current-project-finance-report-summary .total-balance {
            color: var(--secondary-color);
        }

        body.dark-mode .current-project-finance-report-summary .total-income {
            color: #8BC34A;
        }

        body.dark-mode .current-project-finance-report-summary .total-expense {
            color: #EF5350;
        }

        body.dark-mode .current-project-finance-report-summary .total-balance {
            color: var(--dark-primary-color);
        }

        .current-project-finance-report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .current-project-finance-report-table th, .current-project-finance-report-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
            transition: border-color var(--animation-speed);
        }

        .current-project-finance-report-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        body.dark-mode .current-project-finance-report-table th, body.dark-mode .current-project-finance-report-table td {
            border-color: var(--dark-border-color);
        }

        .global-finance-modal-content {
            padding: 30px;
            text-align: right;
        }

        .global-finance-modal-content h3 {
            text-align: center;
        }

        .global-finance-report-summary {
            margin-bottom: 20px;
            font-size: calc(var(--font-size-base) * 1);
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            transition: all var(--animation-speed);
        }

        body.dark-mode .global-finance-report-summary {
            border-color: var(--dark-border-color);
        }

        .global-finance-report-summary div {
            padding: 5px 0;
            font-weight: 700;
        }

        .global-finance-report-summary .total-income {
            color: #4CAF50;
        }

        .global-finance-report-summary .total-expense {
            color: #F44336;
        }

        .global-finance-report-summary .total-balance {
            color: var(--secondary-color);
        }

        body.dark-mode .global-finance-report-summary .total-income {
            color: #8BC34A;
        }

        body.dark-mode .global-finance-report-summary .total-expense {
            color: #EF5350;
        }

        body.dark-mode .global-finance-report-summary .total-balance {
            color: var(--dark-primary-color);
        }

        .global-finance-project-section {
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            transition: all var(--animation-speed);
        }

        body.dark-mode .global-finance-project-section {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border-color: #444;
        }

        .global-finance-project-section h4 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: calc(var(--font-size-base) * 1.1);
            transition: color var(--animation-speed);
        }

        .global-finance-project-section p {
            margin: 5px 0;
            font-size: calc(var(--font-size-base) * 0.9);
        }

        .global-finance-project-section .project-balance {
            font-weight: 700;
        }

        .global-finance-project-section .project-balance.positive {
            color: #4CAF50;
        }

        .global-finance-project-section .project-balance.negative {
            color: #F44336;
        }

        body.dark-mode .global-finance-project-section .project-balance.positive {
            color: #8BC34A;
        }

        body.dark-mode .global-finance-project-section .project-balance.negative {
            color: #EF5350;
        }

        .stage-overview-container {
            margin-bottom: 40px;
        }

        .stage-overview-container h4 {
            text-align: center;
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-family: 'Playfair Display', serif;
            font-size: calc(var(--font-size-base) * 1.3);
            font-weight: 700;
            transition: color var(--animation-speed);
        }

        .step-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .step-preview-card {
            background: linear-gradient(135deg, var(--card-background), #f9f9f9);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .step-preview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .step-preview-card h5 {
            margin-top: 0;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: calc(var(--font-size-base) * 1);
            font-weight: 700;
            transition: color var(--animation-speed);
        }

        .step-preview-card p {
            margin: 3px 0;
            font-size: calc(var(--font-size-base) * 0.8);
            color: var(--text-color);
            transition: color var(--animation-speed);
        }

        .step-preview-card .summary-value {
            font-weight: 700;
            color: var(--secondary-color);
            margin-right: 5px;
            transition: color var(--animation-speed);
        }

        .project-details-card {
            position: fixed;
            top: 15px;
            left: 15px;
            width: 200px;
            height: 250px;
            background: linear-gradient(135deg, var(--card-background), #f9f9f9);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2), 0 0 10px var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 15px 10px;
            z-index: 998;
            font-family: 'Noto Sans Hebrew', sans-serif;
            text-align: right;
            transition: all var(--animation-speed) ease-in-out;
            overflow-y: auto;
        }

        .project-details-card:hover {
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3), 0 0 20px var(--secondary-color);
        }

        .project-details-card h4 {
            font-size: calc(var(--font-size-base) * 1);
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--primary-color);
            text-align: center;
            border-bottom: 1px dashed var(--secondary-color);
            padding-bottom: 8px;
        }

        .project-details-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .project-details-item:last-of-type {
            border-bottom: none;
        }

        .project-details-item:hover {
            background-color: rgba(139, 0, 0, 0.1);
        }

        .project-details-item .detail-label {
            font-size: calc(var(--font-size-base) * 0.9);
            color: var(--light-text-color);
            margin-right: 5px;
            flex-shrink: 0;
        }

        .project-details-item .detail-value {
            font-size: calc(var(--font-size-base) * 1);
            font-weight: 700;
            color: var(--text-color);
            flex-grow: 1;
            text-align: left;
            min-width: 30px;
        }

        .project-details-item input[type="text"], .project-details-item input[type="number"], .project-details-item select {
            width: 100%;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: calc(var(--font-size-base) * 0.9);
            box-sizing: border-box;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .project-details-card::-webkit-scrollbar {
            width: 8px;
            background-color: transparent;
        }

        .project-details-card::-webkit-scrollbar-thumb {
            background-color: transparent;
            border-radius: 4px;
        }

        .project-details-card::-webkit-scrollbar-track {
            background-color: transparent;
        }

        .project-details-card:hover::-webkit-scrollbar-thumb {
            background-color: rgba(139, 0, 0, 0.5);
        }

        .project-details-card:hover::-webkit-scrollbar-track {
            background-color: rgba(139, 0, 0, 0.1);
        }

        body.dark-mode .project-details-card::-webkit-scrollbar-thumb {
            background-color: transparent;
        }

        body.dark-mode .project-details-card:hover::-webkit-scrollbar-thumb {
            background-color: rgba(184, 0, 0, 0.5);
        }

        body.dark-mode .project-details-card:hover::-webkit-scrollbar-track {
            background-color: rgba(184, 0, 0, 0.1);
        }

        .project-details-item.custom-property .detail-value {
            background-color: var(--background-color);
            border-radius: 5px;
            padding: 2px 5px;
            min-height: 1.5em;
        }

        .project-details-item.custom-property:hover .detail-value {
            background-color: #f0f0f0;
        }

        .project-details-item.custom-property .delete-custom-prop-btn {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 3px 6px;
            font-size: calc(var(--font-size-base) * 0.7);
            cursor: pointer;
            margin-left: 5px;
            flex-shrink: 0;
            transition: background 0.2s ease;
        }

        .project-details-item.custom-property .delete-custom-prop-btn:hover {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
        }

        .add-custom-property-btn {
            background: linear-gradient(135deg, var(--accent-color), #FFD700);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: calc(var(--font-size-base) * 0.9);
            font-weight: 700;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }

        .add-custom-property-btn:hover {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            transform: translateY(-2px);
        }

        #datePickerModal .modal-content {
            max-width: 300px;
            padding: 20px;
        }

        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: calc(var(--font-size-base) * 1);
            font-weight: bold;
            color: var(--primary-color);
        }

        .date-picker-header button {
            background: none;
            border: none;
            font-size: calc(var(--font-size-base) * 1.3);
            cursor: pointer;
            color: var(--secondary-color);
            padding: 0 5px;
        }

        .date-picker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
            font-size: calc(var(--font-size-base) * 0.9);
        }

        .date-picker-day {
            padding: 8px 0;
            border-radius: 4px;
            cursor: pointer;
            background-color: #f0f0f0;
            transition: background-color 0.2s;
        }

        .date-picker-day.header {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .date-picker-day:not(.header):hover {
            background-color: #e0e0e0;
        }

        .date-picker-day.selected {
            background-color: var(--secondary-color);
            color: white;
        }

        .date-picker-day.empty {
            background: none;
            cursor: default;
        }

        .date-picker-day.current-month {
            color: var(--text-color);
        }

        .date-picker-day.other-month {
            color: var(--light-text-color);
            opacity: 0.7;
        }

        body.dark-mode .date-picker-day {
            background-color: #3a3a5e;
            color: var(--dark-text-color);
        }

        body.dark-mode .date-picker-day:not(.header):hover {
            background-color: #4a4a7a;
        }

        .date-picker-day.selected {
            background-color: var(--secondary-color);
            color: white;
        }

        body.dark-mode .date-picker-day.selected {
            background-color: var(--dark-secondary-color);
        }

        body.dark-mode .date-picker-header button {
            color: var(--dark-primary-color);
        }

        .instructions-modal-content {
            padding: 30px;
            text-align: right;
        }

        .instructions-modal-content h3 {
            text-align: center;
        }

        .instructions-modal-content p {
            margin-bottom: 1em;
        }

        .instructions-modal-content ul {
            list-style-type: disc;
            margin-right: 20px;
            margin-bottom: 1em;
        }

        .instructions-modal-content li {
            margin-bottom: 0.5em;
        }

        .timeline-modal-content {
            padding: 30px;
            text-align: right;
            max-height: 90vh;
        }

        .timeline-modal-content h3 {
            text-align: center;
            margin-bottom: 20px;
        }

        .timeline-container {
            position: relative;
            padding: 20px 0;
            margin: 0 auto;
            width: 100%;
            height: 500px;
            overflow-x: hidden;
            overflow-y: auto;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 20px;
            padding-top: 20px;
            direction: rtl;
            white-space: normal;
        }

        .timeline-event {
            position: relative;
            margin-bottom: 30px;
            padding-bottom: 20px;
            text-align: right;
            opacity: 0;
            transform: translateX(50px);
            animation: slideInEvent 0.5s forwards;
            display: block;
            vertical-align: top;
            padding-left: 40px;
        }

        @keyframes slideInEvent {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .timeline-event::before {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--primary-color);
            border: 3px solid var(--card-background);
            z-index: 1;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        body.dark-mode .timeline-event::before {
            background-color: var(--dark-primary-color);
            border-color: var(--dark-card-background);
        }

        .timeline-event-content {
            background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        body.dark-mode .timeline-event-content {
            background: linear-gradient(135deg, #3a3a5e, #2a2a2a);
        }

        .timeline-event h4 {
            margin-top: 0;
            margin-bottom: 5px;
            color: var(--secondary-color);
            font-size: calc(var(--font-size-base) * 1);
            transition: color var(--animation-speed);
        }

        .timeline-event p {
            margin: 0;
            font-size: calc(var(--font-size-base) * 0.9);
            color: var(--text-color);
            transition: color var(--animation-speed);
        }

        .timeline-event .event-value {
            font-weight: bold;
            color: var(--primary-color);
            transition: color var(--animation-speed);
        }

        .timeline-event .event-timestamp {
            font-size: calc(var(--font-size-base) * 0.8);
            color: var(--light-text-color);
            margin-top: 5px;
            display: block;
            transition: color var(--animation-speed);
        }

        .download-pdf-btn {
            background: linear-gradient(135deg, var(--accent-color), #FFD700);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: calc(var(--font-size-base) * 1);
            font-weight: 700;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .download-pdf-btn:hover {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            transform: translateY(-2px);
        }

        .finance-yearly-modal-content {
            padding: 30px;
            text-align: right;
        }

        .finance-yearly-modal-content h3 {
            text-align: center;
        }

        .year-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .year-selector select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-background);
            color: var(--text-color);
            font-size: calc(var(--font-size-base) * 0.9);
        }

        body.dark-mode .year-selector select {
            background-color: var(--dark-card-background);
            color: var(--dark-text-color);
            border-color: var(--dark-border-color);
        }

        .year-selector button {
            padding: 8px 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: calc(var(--font-size-base) * 0.9);
            margin-left: 10px;
        }

        .year-selector button:hover {
            background: linear-gradient(135deg, var(--secondary-color), #8B0000);
        }

        .finance-yearly-report-summary {
            margin-bottom: 20px;
            font-size: calc(var(--font-size-base) * 1);
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            transition: border-color var(--animation-speed);
        }

        body.dark-mode .finance-yearly-report-summary {
            border-color: var(--dark-border-color);
        }

        .finance-yearly-report-summary div {
            padding: 5px 0;
            font-weight: 700;
        }

        .finance-yearly-report-summary .total-income {
            color: #4CAF50;
        }

        .finance-yearly-report-summary .total-expense {
            color: #F44336;
        }

        .finance-yearly-report-summary .total-balance {
            color: var(--secondary-color);
        }

        body.dark-mode .finance-yearly-report-summary .total-income {
            color: #8BC34A;
        }

        body.dark-mode .finance-yearly-report-summary .total-expense {
            color: #EF5350;
        }

        body.dark-mode .finance-yearly-report-summary .total-balance {
            color: var(--dark-primary-color);
        }

        .finance-yearly-project-section {
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            transition: all var(--animation-speed);
        }

        body.dark-mode .finance-yearly-project-section {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border-color: #444;
        }

        .finance-yearly-project-section h4 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: calc(var(--font-size-base) * 1.1);
            transition: color var(--animation-speed);
        }

        .finance-yearly-project-section p {
            margin: 5px 0;
            font-size: calc(var(--font-size-base) * 0.9);
        }

        .finance-yearly-project-section .project-balance {
            font-weight: 700;
        }

        .finance-yearly-project-section .project-balance.positive {
            color: #4CAF50;
        }

        .finance-yearly-project-section .project-balance.negative {
            color: #F44336;
        }

        body.dark-mode .finance-yearly-project-section .project-balance.positive {
            color: #8BC34A;
        }

        body.dark-mode .finance-yearly-project-section .project-balance.negative {
            color: #EF5350;
        }

        .reminders-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        .reminders-modal-content {
            background: linear-gradient(135deg, var(--card-background), #f9f9f9);
            margin: auto;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 80%;
            max-width: 600px;
            animation: slideInModal 0.4s ease-out;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        body.dark-mode .reminders-modal-content {
            background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
        }

        .reminders-list {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .reminders-list li {
            background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: calc(var(--font-size-base) * 1);
            transition: all var(--animation-speed);
        }

        body.dark-mode .reminders-list li {
            background: linear-gradient(135deg, #3a3a5e, #2a2a2a);
            border-color: var(--dark-border-color);
            color: var(--dark-text-color);
        }

        .reminder-details {
            flex-grow: 1;
        }

        .reminder-details .text {
            font-weight: 700;
            color: var(--primary-color);
        }

        .reminder-details .datetime {
            font-size: calc(var(--font-size-base) * 0.8);
            color: var(--light-text-color);
            margin-top: 5px;
        }

        .reminder-actions button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            margin-right: 8px;
            font-size: calc(var(--font-size-base) * 0.8);
            transition: color 0.2s ease;
        }

        .reminder-actions button:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        .reminder-actions button.delete {
            color: #f44336;
        }

        .reminder-actions button.delete:hover {
            color: #d32f2f;
        }

        .add-reminder-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-reminder-form input, .add-reminder-form textarea {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: calc(var(--font-size-base) * 1);
            background-color: var(--card-background);
            color: var(--text-color);
            transition: all var(--animation-speed);
        }

        body.dark-mode .add-reminder-form input, body.dark-mode .add-reminder-form textarea {
            background-color: var(--dark-card-background);
            color: var(--dark-text-color);
            border-color: var(--dark-border-color);
        }

        .add-reminder-form button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: calc(var(--font-size-base) * 1);
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .add-reminder-form button:hover {
            background: linear-gradient(135deg, var(--secondary-color), #8B0000);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                padding-bottom: 150px;
            }

            .top-section-wrapper {
                padding-top: 10px;
                border-radius: 0;
                padding-left: 10px;
                padding-right: 10px;
            }

            .container {
                padding: 20px;
                margin: 10px auto;
            }

            .hamburger-menu-btn {
                top: 10px;
                right: 10px;
                width: 35px;
                height: 35px;
                gap: 5px;
            }

            .hamburger-menu-btn span {
                width: 20px;
                height: 2px;
            }

            .hamburger-menu-btn.open span:nth-child(1) {
                transform: translateY(7px) rotate(45deg);
            }

            .hamburger-menu-btn.open span:nth-child(3) {
                transform: translateY(-7px) rotate(-45deg);
            }

            .project-header h2 {
                font-size: calc(var(--font-size-base) * 1.2);
            }

            #editProjectNameInput {
                font-size: calc(var(--font-size-base) * 1);
            }

            .stage-nav-container {
                flex-direction: column;
                gap: 10px;
            }

            .stage-nav-container > div {
                width: 100%;
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }

            .wine-icon-container {
                order: -1;
                margin-bottom: 10px;
            }

            .stage-nav-button {
                min-width: 90px;
                padding: 8px 10px;
                font-size: calc(var(--font-size-base) * 0.8);
            }

            .dashboard-section {
                padding: 10px;
            }

            .dashboard-section h2 {
                font-size: calc(var(--font-size-base) * 1.2);
                margin-bottom: 5px;
            }

            .dashboard-grid {
                justify-content: space-around;
            }

            .dashboard-item {
                padding: 5px 8px;
                min-width: unset;
                width: 30%;
                font-size: calc(var(--font-size-base) * 0.7);
                min-height: 70px;
            }

            .dashboard-item h3 {
                font-size: calc(var(--font-size-base) * 0.7);
            }

            .dashboard-item p {
                font-size: calc(var(--font-size-base) * 1);
            }

            .input-section {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 30px;
                padding-top: 10px;
            }

            .input-group {
                padding: 15px;
            }

            .input-group label {
                font-size: calc(var(--font-size-base) * 1);
            }

            .input-group input[type="number"], .input-group input[type="text"], .input-group select, .input-group textarea {
                padding: 10px;
                font-size: calc(var(--font-size-base) * 0.9);
            }

            .input-group button {
                padding: 10px 15px;
                font-size: calc(var(--font-size-base) * 0.9);
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 95vh;
            }

            .close-button {
                font-size: calc(var(--font-size-base) * 1.5);
                top: 5px;
                left: 10px;
            }

            .modal-content h3 {
                font-size: calc(var(--font-size-base) * 1.2);
                margin-bottom: 15px;
                padding-bottom: 8px;
            }

            .modal-graph-container {
                height: 180px;
                margin: 15px auto 20px auto;
            }

            .modal-graph-label-x {
                font-size: calc(var(--font-size-base) * 0.5);
                transform: rotate(-45deg);
                transform-origin: center center;
            }

            .modal-graph-label-y {
                font-size: calc(var(--font-size-base) * 0.5);
            }

            .modal-graph-average-label {
                font-size: calc(var(--font-size-base) * 0.7);
                text-anchor: end;
                x: 95%;
            }

            .history-list {
                max-height: 200px;
                margin-top: 15px;
            }

            .history-list li {
                flex-wrap: wrap;
                justify-content: flex-end;
                padding: 10px;
                margin-bottom: 5px;
                font-size: calc(var(--font-size-base) * 0.9);
            }

            .history-list li strong {
                flex-basis: auto;
                margin-left: 10px;
            }

            .history-list li span.timestamp {
                width: 100%;
                text-align: right;
                margin-top: 5px;
                font-size: calc(var(--font-size-base) * 0.7);
            }

            .history-list li .undo-button {
                margin-top: 10px;
                margin-right: 0;
                width: 100%;
                padding: 6px 10px;
                font-size: calc(var(--font-size-base) * 0.7);
            }

            .sidebar {
                width: 220px;
            }

            .sidebar ul li a, .sidebar ul li button {
                padding: 12px 20px;
                font-size: calc(var(--font-size-base) * 1);
            }

            .sidebar .divider {
                margin: 10px 15px;
            }

            .sidebar-footer {
                padding: 15px 20px;
            }

            .project-modal-content, .finance-modal-content, .global-finance-modal-content, .instructions-modal-content, .timeline-modal-content, #datePickerModal .modal-content {
                padding: 15px;
            }

            .finance-input-group {
                gap: 10px;
                padding: 10px;
            }

            .finance-input-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .finance-input-buttons button {
                padding: 8px 12px;
                font-size: calc(var(--font-size-base) * 0.9);
            }

            .finance-list {
                max-height: 180px;
            }

            .finance-list li {
                padding: 8px 12px;
                margin-bottom: 5px;
                font-size: calc(var(--font-size-base) * 0.9);
            }

            .finance-item-actions button {
                margin-right: 5px;
                font-size: calc(var(--font-size-base) * 0.8);
            }

            .finance-balance-total {
                font-size: calc(var(--font-size-base) * 1);
                padding-top: 10px;
            }

            .global-finance-report-summary {
                font-size: calc(var(--font-size-base) * 1);
                padding-bottom: 10px;
            }

            .global-finance-project-section h4 {
                font-size: calc(var(--font-size-base) * 1);
            }

            .global-finance-project-section p {
                font-size: calc(var(--font-size-base) * 0.9);
            }

            .step-cards-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .step-preview-card {
                padding: 12px 15px;
            }

            .step-preview-card h5 {
                font-size: calc(var(--font-size-base) * 1);
            }

            .step-preview-card p {
                font-size: calc(var(--font-size-base) * 0.8);
            }

            .project-details-card {
                position: fixed;
                top: 10px;
                left: 10px;
                width: calc(100vw - 80px);
                max-height: calc(100vh - 100px);
                overflow-y: auto;
                box-shadow: var(--shadow);
                border: 1px solid var(--border-color);
                padding: 15px;
            }

            .project-details-card:hover {
                box-shadow: var(--shadow);
                transform: none;
            }
        }

        .auth-section {
            width: 100%;
            text-align: center;
        }

        .auth-section .auth-status {
            font-size: calc(var(--font-size-base) * 0.9);
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .auth-section button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: calc(var(--font-size-base) * 0.9);
            margin: 5px;
            transition: all 0.3s ease;
        }

        .auth-section button:hover {
            background: linear-gradient(135deg, var(--secondary-color), #8B0000);
            transform: translateY(-2px);
        }

        .auth-section .logout-btn {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .auth-section .logout-btn:hover {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
        }
    </style>
</head>
<body>
    
    <div class="hamburger-menu-btn" id="hamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div class="sidebar" id="sidebar">
        <ul>
            <li><a href="#" onclick="closeSidebar(); showMainContent();">ראשי</a></li>
            <li><button onclick="openProjectManagementModal();">ניהול פרויקטים</button></li>
            <li><button onclick="openFinanceModal();">ניהול כספים</button></li>
            <li><button onclick="openCurrentProjectFinanceReportModal();">דוח כספי</button></li>
            <li><button onclick="openGlobalFinanceReportModal();">דוח כספי כולל</button></li>
            <li><button onclick="openFinanceYearlyModal();">דוח כספי לפי שנה</button></li>
            <li><button onclick="openInboxModal();">תיבת דואר</button></li>
            <li><button onclick="openRemindersModal();">תזכורות</button></li>
            <li class="divider"></li>
            <li><button onclick="openInstructionsModal()">הוראות</button></li>
            <li><button onclick="openTimelineModal()">ציר זמן</button></li>
        </ul>
        <div class="sidebar-footer">
            <div class="auth-section">
                <div class="auth-status" id="authStatus">לא מחובר</div>
                <button id="loginBtn">התחבר עם Google</button>
                <button id="logoutBtn" class="logout-btn" style="display:none;">יציאה</button>
            </div>
            <div class="divider"></div>
            <div class="zoom-controls">
                <button onclick="zoomIn()">+</button>
                <button onclick="zoomOut()">-</button>
            </div>
            <div class="theme-switch">
                מצב כהה:
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="top-section-wrapper">
        <div class="container">
            <div class="project-header">
                <h2 id="currentProjectName">פרויקט ראשי</h2>
                <input type="text" id="editProjectNameInput" style="display:none;">
            </div>

            <div class="stage-nav-container" id="stageNavContainer">
                <!-- Stages will be added here -->
            </div>
        </div>
    </div>

    <div class="container">
        <div class="project-details-card" id="projectDetailsCard">
            <h4>פרטי פרויקט</h4>
            <div class="project-details-item" data-metric-id="wineName" data-section="wineDetails">
                <span class="detail-label">שם היין:</span>
                <span class="detail-value editable">--</span>
            </div>
            <div class="project-details-item" data-metric-id="vintageYear" data-section="wineDetails">
                <span class="detail-label">שנה:</span>
                <span class="detail-value editable">--</span>
            </div>
            <div class="project-details-item" data-metric-id="grapeVariety" data-section="wineDetails">
                <span class="detail-label">זן הענבים:</span>
                <span class="detail-value editable">--</span>
            </div>
            <div class="project-details-item" data-metric-id="vineyardSource" data-section="wineDetails">
                <span class="detail-label">מקור הענבים:</span>
                <span class="detail-value editable">--</span>
            </div>
            <div class="project-details-item" data-metric-id="generalNotes" data-section="wineDetails">
                <span class="detail-label">הערות נוספות:</span>
                <span class="detail-value editable">--</span>
            </div>
            <div class="project-details-item" data-metric-id="harvestDate" data-section="wineDetails">
                <span class="detail-label">תאריך בציר:</span>
                <span class="detail-value editable">--</span>
            </div>
            <button class="add-custom-property-btn" onclick="addCustomProperty()">+ הוסף שדה מותאם אישית</button>
        </div>

        <div class="stage-overview-container" id="stageOverviewContainer" style="display: none;">
            <h4>נתונים משלבים קודמים</h4>
            <div class="step-cards-grid" id="stepCardsGrid">
                <!-- Previous stages will be added here -->
            </div>
        </div>

        <div id="currentStageContent">
            <div class="input-section" id="currentStageInputSection">
                <!-- Current stage inputs will be added here -->
            </div>
        </div>
    </div>

    <div class="dashboard-section" id="fixedDashboardSection">
        <h2 id="fixedDashboardStageName"></h2>
        <div class="dashboard-grid" id="fixedDashboardGrid">
            <!-- Dashboard items will be added here -->
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeHistoryModal()">&times;</span>
            <h3 id="modalTitle"></h3>
            <div class="graph-controls">
                <button onclick="openProjectSelectionForComparison()">השווה לפרויקט אחר</button>
            </div>
            <div class="modal-graph-container">
                <svg class="modal-graph-svg" id="modalGraphSvg"></svg>
            </div>
            <ul id="historyList" class="history-list">
                <!-- History items will be added here -->
            </ul>
        </div>
    </div>

    <div id="projectManagementModal" class="modal">
        <div class="modal-content project-modal-content">
            <span class="close-button" onclick="closeProjectManagementModal()">&times;</span>
            <h3>ניהול פרויקטים</h3>
            <div class="project-filter">
                <label for="projectYearFilter">סינון לפי שנה:</label>
                <select id="projectYearFilter">
                    <option value="all">כל השנים</option>
                    <!-- Years from 2020 to 2100 -->
                </select>
            </div>
            <ul id="projectList" class="project-list">
                <!-- Project list will be added here -->
            </ul>
            <button class="add-project-btn" onclick="addNewProject()">+ כרטיסייה חדשה</button>
        </div>
    </div>

    <div id="financeModal" class="modal">
        <div class="modal-content finance-modal-content">
            <span class="close-button" onclick="closeFinanceModal()">&times;</span>
            <h3>ניהול כספים בפרויקט הנוכחי</h3>
            <div class="finance-input-group">
                <label for="financeAmount">סכום:</label>
                <input type="number" id="financeAmount" placeholder="הכנס סכום">
                <label for="financeNotes">הערות:</label>
                <textarea id="financeNotes" placeholder="הכנס הערות (אופציונלי)" rows="3"></textarea>
                <div class="finance-input-buttons">
                    <button class="add-income-btn" onclick="addFinanceEntry('income')">הוסף הכנסה</button>
                    <button class="add-expense-btn" onclick="addFinanceEntry('expense')">הוסף הוצאה</button>
                </div>
            </div>
            <ul id="financeList" class="finance-list">
                <!-- Finance items will be added here -->
            </ul>
            <div class="finance-balance-total">
                יתרה נוכחית: <span id="currentBalance">0</span>
            </div>
        </div>
    </div>

    <div id="currentProjectFinanceReportModal" class="modal current-project-finance-report-modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCurrentProjectFinanceReportModal()">&times;</span>
            <h3>דוח כספי - פרויקט נוכחי</h3>
            <div class="current-project-finance-report-summary">
                <div class="total-income">סה"כ הכנסות: <span id="currentProjectTotalIncome">0</span></div>
                <div class="total-expense">סה"כ הוצאות: <span id="currentProjectTotalExpense">0</span></div>
                <div class="total-balance">יתרה נוכחית: <span id="currentProjectTotalBalance">0</span></div>
            </div>
            <table class="current-project-finance-report-table" id="currentProjectFinanceReportTable">
                <thead>
                    <tr>
                        <th>תאריך</th>
                        <th>סוג</th>
                        <th>סכום</th>
                        <th>הערות</th>
                    </tr>
                </thead>
                <tbody id="currentProjectFinanceReportTableBody">
                    <!-- Finance entries will be added here -->
                </tbody>
            </table>
            <button class="download-pdf-btn" onclick="downloadCurrentProjectFinancePDF()">הורד כ-PDF</button>
        </div>
    </div>

    <div id="globalFinanceReportModal" class="modal">
        <div class="modal-content global-finance-modal-content">
            <span class="close-button" onclick="closeGlobalFinanceReportModal()">&times;</span>
            <h3>דוח כספי כולל (כל הפרויקטים)</h3>
            <div class="global-finance-report-summary">
                <div class="total-income">סה"כ הכנסות: <span id="globalTotalIncome">0</span></div>
                <div class="total-expense">סה"כ הוצאות: <span id="globalTotalExpense">0</span></div>
                <div class="total-balance">יתרה כוללת: <span id="globalTotalBalance">0</span></div>
            </div>
            <div id="globalFinanceProjectsDetails">
                <!-- Project details will be added here -->
            </div>
            <button class="download-pdf-btn" onclick="downloadGlobalFinancePDF()">הורד כ-PDF</button>
        </div>
    </div>

    <div id="financeYearlyModal" class="modal">
        <div class="modal-content finance-yearly-modal-content">
            <span class="close-button" onclick="closeFinanceYearlyModal()">&times;</span>
            <h3>דוח כספי לפי שנה</h3>
            <div class="year-selector">
                <label for="yearSelect">בחר שנה:</label>
                <select id="yearSelect">
                    <!-- Years from 2020 to 2100 -->
                </select>
                <button onclick="generateYearlyReport()">צור דוח</button>
            </div>
            <div id="yearlyReportContent" style="display:none;">
                <div class="finance-yearly-report-summary">
                    <div class="total-income">סה"כ הכנסות: <span id="yearlyTotalIncome">0</span></div>
                    <div class="total-expense">סה"כ הוצאות: <span id="yearlyTotalExpense">0</span></div>
                    <div class="total-balance">יתרה נוכחית: <span id="yearlyTotalBalance">0</span></div>
                </div>
                <div id="yearlyFinanceProjectsDetails">
                    <!-- Project details will be added here -->
                </div>
                <button class="download-pdf-btn" onclick="downloadYearlyFinancePDF()">הורד כ-PDF</button>
            </div>
        </div>
    </div>

    <div id="inboxModal" class="reminders-modal">
        <div class="reminders-modal-content">
            <span class="close-button" onclick="closeInboxModal()">&times;</span>
            <h3>תיבת דואר</h3>
            <ul id="inboxList" class="reminders-list">
                <!-- Inbox items will be added here -->
            </ul>
        </div>
    </div>

    <div id="remindersModal" class="reminders-modal">
        <div class="reminders-modal-content">
            <span class="close-button" onclick="closeRemindersModal()">&times;</span>
            <h3>תזכורות</h3>
            <div class="add-reminder-form">
                <input type="text" id="reminderText" placeholder="טקסט התזכורת">
                <input type="datetime-local" id="reminderDateTime">
                <label><input type="checkbox" id="reminderPopup"> הצג כהודעה קופצת בדפדפן</label>
                <button onclick="addReminder()">הוסף תזכורת</button>
            </div>
            <ul id="remindersList" class="reminders-list">
                <!-- Reminders will be added here -->
            </ul>
        </div>
    </div>

    <div id="instructionsModal" class="modal">
        <div class="modal-content instructions-modal-content">
            <span class="close-button" onclick="closeInstructionsModal()">&times;</span>
            <h3>הוראות שימוש באתר</h3>
            <p>ברוכים הבאים למערכת ניטור וניהול יין! כאן תוכלו לעקוב אחר תהליך ייצור היין שלכם שלב אחר שלב, לנהל פרויקטים שונים, לעקוב אחר הוצאות והכנסות, ולצפות בדוחות מפורטים.</p>
            <h4>תכונות עיקריות:</h4>
            <ul>
                <li>**ניהול פרויקטים:** צרו פרויקטים שונים (לדוגמה, "קברנה 2024", "מרלו 2023") ונהלו את הנתונים עבור כל אחד בנפרד.</li>
                <li>**שלבי ייצור:** כל פרויקט מחולק לשלבי ייצור מוגדרים מראש, שלכל אחד מהם יש מדדים רלוונטיים.</li>
                <li>**הזנת מדדים:** הזינו בקלות נתונים בשדות המתאימים ולחצו "עדכן".</li>
                <li>**צפייה בהיסטוריה:** לחצו על כל שורת מדד או פריט בלוח המחוונים כדי לראות את ההיסטוריה המלאה שלו עם גרף.</li>
                <li>**עריכת שם פרויקט:** לחצו על שם הפרויקט (ליד "מערכת ניטור נתונים") כדי לערוך אותו.</li>
                <li>**כרטיסיית פרטי פרויקט:** בצד שמאל למעלה, לחצו על כל פרט (שם יין, תאריך בציר וכו') כדי לערוך אותו. ניתן גם להוסיף שדות מותאמים אישית.</li>
            </ul>
            <h4>כיצד להשתמש:</h4>
            <ul>
                <li>**תפריט המבורגר (מימין למעלה):** לחצו על האייקון (שלושה קווים) כדי לפתוח את תפריט הניווט.</li>
                <li>**מעבר בין שלבים:** השתמשו בכפתורי השלבים (לדוגמה, "בציר") כדי לעבור בין שלבי הייצור של הפרויקט הנוכחי.</li>
                <li>**ציר זמן:** צפו בכל המדידות של הפרויקט הנוכחי על גבי ציר זמן כרונולוגי אחד.</li>
                <li>**ניהול כספים:** עקבו אחר הכנסות והוצאות לכל פרויקט, וצפו ביתרה הנוכחית. ניתן לסנן לפי סוג תנועה ותאריך.</li>
                <li>**דוח כספי:** קבלו סיכום פיננסי רק לפרויקט הנוכחי.</li>
                <li>**דוח כספי כולל:** קבלו סיכום פיננסי משולב מכל הפרויקטים שלכם.</li>
                <li>**תזכורות:** הוסיפו תזכורות עם טקסט ותאריך/שעה, ותקבלו הודעה בדפדפן כשהזמן מגיע.</li>
                <li>**תיבת דואר:** צפו בתזכורות שהתקבלו.</li>
                <li>**מצב כהה:** עברו למצב תצוגה כהה לנוחות מירבית.</li>
            </ul>
        </div>
    </div>

    <div id="timelineModal" class="modal">
        <div class="modal-content timeline-modal-content">
            <span class="close-button" onclick="closeTimelineModal()">&times;</span>
            <h3>ציר זמן - כל המדידות</h3>
            <div class="timeline-container" id="timelineContainer">
                <!-- Timeline events will be added here -->
            </div>
            <button class="download-pdf-btn" onclick="downloadTimelinePDF()">הורד כ-PDF</button>
        </div>
    </div>

    <div id="datePickerModal" class="modal">
        <div class="modal-content date-picker-modal-content">
            <span class="close-button" onclick="closeDatePickerModal()">&times;</span>
            <div class="date-picker-header">
                <button id="prevMonthBtn"> &#8249; </button>
                <span id="currentMonthYear"></span>
                <button id="nextMonthBtn"> &#8250; </button>
            </div>
            <div class="date-picker-grid" id="datePickerGrid">
                <div class="date-picker-day header">א</div>
                <div class="date-picker-day header">ב</div>
                <div class="date-picker-day header">ג</div>
                <div class="date-picker-day header">ד</div>
                <div class="date-picker-day header">ה</div>
                <div class="date-picker-day header">ו</div>
                <div class="date-picker-day header">ש</div>
            </div>
        </div>
    </div>

    <div id="projectSelectionModal" class="modal">
        <div class="modal-content project-modal-content">
            <span class="close-button" onclick="closeProjectSelectionModal()">&times;</span>
            <h3>בחר פרויקט להשוואה</h3>
            <ul id="comparisonProjectList" class="project-list">
                <!-- Project list for comparison will be added here -->
            </ul>
        </div>
    </div>

    <script>
        const stagesConfig = {
            'wineDetails': {
                name: 'פרטי יין',
                longName: 'פרטי יין',
                metrics: {
                    'wineName': { name: 'שם היין', type: 'text', placeholder: 'קברנה יקב הידון 2024' },
                    'vintageYear': { name: 'שנה', type: 'number', step: 1, precision: 0, placeholder: '2024' },
                    'grapeVariety': { name: 'זן הענבים', type: 'select', options: ['קברנה סוביניון', 'מרלו', 'שיראז', 'שרדונה', 'סוביניון בלאן', 'פינו נואר', 'גרנאש', 'זינפנדל','ריזלינג', 'גוורצטרמינר', 'שן בלאן', 'ויונייה', 'ברברה', 'סנג\'ובזה', 'נביולו', 'טמפרניו', 'אחר'], placeholder: 'בחר זן' },
                    'vineyardSource': { name: 'מקור הענבים', type: 'text', placeholder: 'כרם גליל עליון' },
                    'harvestDate': { name: 'תאריך בציר', type: 'date', placeholder: 'בחר תאריך' },
                    'generalNotes': { name: 'הערות נוספות', type: 'text', placeholder: 'יין בעל פוטנציאל יישון' }
                },
                customMetrics: {}
            },
            'stage1': {
                name: 'בציר',
                longName: 'בציר',
                emoji: '🟢',
                metrics: {
                    'brix': { name: 'בריקס', type: 'number', step: 0.1, precision: 1, placeholder: '22.5' },
                    'ph': { name: 'pH', type: 'number', step: 0.01, precision: 2, placeholder: '3.5' },
                    'ta': { name: 'חומצה כוללת', type: 'number', step: 0.01, precision: 2, placeholder: '6.8' },
                    'grapeTemp': { name: 'טמפרטורת ענבים', type: 'number', step: 0.1, precision: 1, placeholder: '25.0' },
                },
                summaryMetrics: ['brix', 'ph', 'ta']
            },
            'stage2': {
                name: 'ריסוק',
                longName: 'ריסוק והכנה לתסיסה',
                emoji: '🍇',
                metrics: {
                    'so2Added': { name: 'SO₂', type: 'number', step: 0.1, precision: 1, placeholder: '50' },
                    'enzymesAdded': { name: 'אנזימים', type: 'number', step: 0.1, precision: 1, placeholder: '0.8' },
                    'mixTemp': { name: 'טמפרטורת תערובת', type: 'number', step: 0.1, precision: 1, placeholder: '18.0' },
                    'skinLiquidRatio': { name: 'יחס קליפות/נוזלים', type: 'text', placeholder: '1:3' },
                    'brixStart': { name: 'בריקס התחלה', type: 'number', step: 0.1, precision: 1, placeholder: '23.0' },
                    'fermentationSync': { name: 'מצב סנכרון', type: 'text', placeholder: 'אושר' }
                },
                summaryMetrics: ['so2Added', 'mixTemp', 'brixStart']
            },
            'stage3': {
                name: 'תסיסה אלכוהולית',
                longName: 'תסיסה אלכוהולית',
                emoji: '🍷',
                metrics: {
                    'brixDaily': { name: 'בריקס יומי', type: 'number', step: 0.1, precision: 1, placeholder: '15.0' },
                    'phFerment': { name: 'pH', type: 'number', step: 0.01, precision: 2, placeholder: '3.65' },
                    'fermentTemp': { name: 'טמפרטורת תסיסה', type: 'number', step: 0.1, precision: 1, placeholder: '26.5' },
                    'yeastAdded': { name: 'שמרים', type: 'text', placeholder: 'EC-1118' },
                    'yeastFoodAdded': { name: 'מזון שמרים', type: 'text', placeholder: '2 גרם/ליטר' },
                    'density': { name: 'צפיפות (SG)', type: 'number', step: 0.001, precision: 3, placeholder: '1.050' },
                    'fermentRate': { name: 'קצב תסיסה', type: 'text', placeholder: 'יציב / מהיר' },
                    'fermentStartDate': { name: 'תאריך התחלה', type: 'date', placeholder: '20/08/2024' },
                    'fermentEndDate': { name: 'תאריך סיום', type: 'date', placeholder: '30/08/2024' }
                },
                summaryMetrics: ['brixDaily', 'phFerment', 'fermentTemp', 'density']
            },
            'stage4': {
                name: 'תסיסה מלולקטית',
                longName: 'תסיסה מלולקטית',
                emoji: '🔁',
                metrics: {
                    'phMLF': { name: 'pH', type: 'number', step: 0.01, precision: 2, placeholder: '3.80' },
                    'malicAcid': { name: 'חומצה מלית', type: 'text', placeholder: 'ירידה קלה' },
                    'roomTempMLF': { name: 'טמפרטורת חדר', type: 'number', step: 0.1, precision: 1, placeholder: '20.0' },
                    'mlfStatus': { name: 'מצב תסיסה', type: 'text', placeholder: 'באמצע' },
                    'bacteriaAdded': { name: 'חיידקים', type: 'text', placeholder: 'Oenococcus oeni' },
                    'tasteNotesMLF': { name: 'טעמים (רישום ידני)', type: 'text', placeholder: 'חמאתיות עדינה' }
                },
                summaryMetrics: ['phMLF', 'roomTempMLF', 'mlfStatus']
            },
            'stage5': {
                name: 'יישון',
                longName: 'יישון',
                emoji: '🛢',
                metrics: {
                    'containerType': { name: 'סוג מיכל', type: 'text', placeholder: 'חבית עץ אלון צרפתי' },
                    'agingTime': { name: 'זמן יישון (ימים)', type: 'number', step: 1, precision: 0, placeholder: '180' },
                    'agingRoomTemp': { name: 'טמפרטורת חדר יישון', type: 'number', step: 0.1, precision: 1, placeholder: '15.0' },
                    'so2Control': { name: 'פקדי חמצון (SO₂)', type: 'text', placeholder: 'בדיקה חודשית' },
                    'tasteTextureNotes': { name: 'טעמים ומרקם', type: 'text', placeholder: 'עיגול טעמים, טאנינים רכים' },
                    'rackingDate': { name: 'תאריך שקיעה', type: 'date', placeholder: '01/03/2025' },
                    'rackingFrequency': { name: 'תדירות שקיעות', type: 'text', placeholder: 'כל חודשיים' }
                },
                summaryMetrics: ['containerType', 'agingTime', 'agingRoomTemp']
            },
            'stage6': {
                name: 'הכנה לבקבוק',
                longName: 'הכנה לבקבוק',
                emoji: '🧪',
                metrics: {
                    'phFinal': { name: 'pH סופי', type: 'number', step: 0.01, precision: 2, placeholder: '3.75' },
                    'clarity': { name: 'צלילות', type: 'text', placeholder: 'צלול לגמרי' },
                    'bottlingDate': { name: 'תאריך בקבוק', type: 'date', placeholder: '15/05/2025' },
                    'bottleCount': { name: 'כמות בקבוקים', type: 'number', step: 1, precision: 0, placeholder: '750' },
                    'so2AddedBottle': { name: 'תוספת SO₂', type: 'number', step: 0.1, precision: 1, placeholder: '30' },
                    'alcoholLevel': { name: 'רמת אלכוהול (%)', type: 'number', step: 0.1, precision: 1, placeholder: '14.2' },
                    'batchNumber': { name: 'מספר אצווה / תווית', type: 'text', placeholder: 'יין אדום 2024A' }
                },
                summaryMetrics: ['phFinal', 'bottleCount', 'alcoholLevel']
            },
        };

        let projects = loadProjects();
        let currentProjectId = localStorage.getItem('currentProjectId') || Object.keys(projects)[0];
        let currentStageId = localStorage.getItem('currentStageId') || 'stage1';

        if (!currentProjectId || !projects[currentProjectId]) {
            currentProjectId = 'default_project';
            if (!projects[currentProjectId]) {
                projects[currentProjectId] = createNewProjectData('פרויקט ראשי');
            }
            localStorage.setItem('currentProjectId', currentProjectId);
        }

        if (!stagesConfig[currentStageId] || currentStageId === 'wineDetails') {
            currentStageId = 'stage1';
            localStorage.setItem('currentStageId', currentStageId);
        }

        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const projectYearFilter = document.getElementById('projectYearFilter');
        const yearSelect = document.getElementById('yearSelect');

        const currentProjectNameDisplay = document.getElementById('currentProjectName');
        const editProjectNameInput = document.getElementById('editProjectNameInput');

        const projectDetailsCard = document.getElementById('projectDetailsCard');

        const stageNavContainer = document.getElementById('stageNavContainer');
        const stageOverviewContainer = document.getElementById('stageOverviewContainer');
        const stepCardsGrid = document.getElementById('stepCardsGrid');
        const currentStageContent = document.getElementById('currentStageContent');
        const currentStageInputSection = document.getElementById('currentStageInputSection');

        const fixedDashboardSection = document.getElementById('fixedDashboardSection');
        const fixedDashboardStageName = document.getElementById('fixedDashboardStageName');
        const fixedDashboardGrid = document.getElementById('fixedDashboardGrid');

        const historyModal = document.getElementById('historyModal');
        const modalTitle = document.getElementById('modalTitle');
        const historyList = document.getElementById('historyList');
        const modalGraphSvg = document.getElementById('modalGraphSvg');

        const projectManagementModal = document.getElementById('projectManagementModal');
        const projectList = document.getElementById('projectList');

        const financeModal = document.getElementById('financeModal');
        const financeAmountInput = document.getElementById('financeAmount');
        const financeNotesInput = document.getElementById('financeNotes');
        const financeList = document.getElementById('financeList');
        const currentBalanceDisplay = document.getElementById('currentBalance');

        const currentProjectFinanceReportModal = document.getElementById('currentProjectFinanceReportModal');
        const currentProjectTotalIncomeDisplay = document.getElementById('currentProjectTotalIncome');
        const currentProjectTotalExpenseDisplay = document.getElementById('currentProjectTotalExpense');
        const currentProjectTotalBalanceDisplay = document.getElementById('currentProjectTotalBalance');
        const currentProjectFinanceReportTableBody = document.getElementById('currentProjectFinanceReportTableBody');

        const globalFinanceReportModal = document.getElementById('globalFinanceReportModal');
        const globalTotalIncomeDisplay = document.getElementById('globalTotalIncome');
        const globalTotalExpenseDisplay = document.getElementById('globalTotalExpense');
        const globalTotalBalanceDisplay = document.getElementById('globalTotalBalance');
        const globalFinanceProjectsDetails = document.getElementById('globalFinanceProjectsDetails');

        const financeYearlyModal = document.getElementById('financeYearlyModal');
        const yearlyReportContent = document.getElementById('yearlyReportContent');
        const yearlyTotalIncomeDisplay = document.getElementById('yearlyTotalIncome');
        const yearlyTotalExpenseDisplay = document.getElementById('yearlyTotalExpense');
        const yearlyTotalBalanceDisplay = document.getElementById('yearlyTotalBalance');
        const yearlyFinanceProjectsDetails = document.getElementById('yearlyFinanceProjectsDetails');

        const inboxModal = document.getElementById('inboxModal');
        const inboxList = document.getElementById('inboxList');

        const remindersModal = document.getElementById('remindersModal');
        const reminderTextInput = document.getElementById('reminderText');
        const reminderDateTimeInput = document.getElementById('reminderDateTime');
        const reminderPopupInput = document.getElementById('reminderPopup');
        const remindersList = document.getElementById('remindersList');

        const instructionsModal = document.getElementById('instructionsModal');
        const timelineModal = document.getElementById('timelineModal');
        const timelineContainer = document.getElementById('timelineContainer');
        const datePickerModal = document.getElementById('datePickerModal');
        const datePickerGrid = document.getElementById('datePickerGrid');
        const currentMonthYearDisplay = document.getElementById('currentMonthYear');
        let datePickerCurrentMonth = new Date().getMonth();
        let datePickerCurrentYear = new Date().getFullYear();
        let datePickerCallback = null;

        const projectSelectionModal = document.getElementById('projectSelectionModal');
        const comparisonProjectList = document.getElementById('comparisonProjectList');

        let currentMetricTypeForModal = { sectionId: '', metricId: '' };
        let currentEditableDetailElement = null;

        let graphComparisonMode = null;
        let comparisonProjectId = null;

        let inbox = JSON.parse(localStorage.getItem('inbox')) || [];
        let reminders = JSON.parse(localStorage.getItem('reminders')) || [];

        function populateYearSelects() {
            const currentYear = new Date().getFullYear();
            for (let year = 2020; year <= 2100; year++) {
                const option1 = document.createElement('option');
                option1.value = year;
                option1.textContent = year;
                projectYearFilter.appendChild(option1);
                const option2 = document.createElement('option');
                option2.value = year;
                option2.textContent = year;
                yearSelect.appendChild(option2);
            }
            projectYearFilter.value = 'all';
            yearSelect.value = currentYear;
        }

        function zoomIn() {
            const root = document.documentElement;
            const currentSize = parseInt(getComputedStyle(root).getPropertyValue('--font-size-base'));
            root.style.setProperty('--font-size-base', (currentSize + 2) + 'px');
        }

        function zoomOut() {
            const root = document.documentElement;
            const currentSize = parseInt(getComputedStyle(root).getPropertyValue('--font-size-base'));
            if (currentSize > 10) {
                root.style.setProperty('--font-size-base', (currentSize - 2) + 'px');
            }
        }

        function toggleGraphComparison(mode) {
            graphComparisonMode = mode;
            // Re-draw graph with comparison
            const metricDisplayName = stagesConfig[currentMetricTypeForModal.sectionId]?.metrics[currentMetricTypeForModal.metricId]?.name || 'מדד';
            openHistoryModal(currentMetricTypeForModal.sectionId, currentMetricTypeForModal.metricId, metricDisplayName);
        }

        function openProjectSelectionForComparison() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            projectSelectionModal.style.display = 'flex';
            renderComparisonProjectList();
        }

        function closeProjectSelectionModal() {
            projectSelectionModal.style.display = 'none';
            showMainContent();
        }

        function renderComparisonProjectList() {
            comparisonProjectList.innerHTML = '';
            Object.keys(projects).forEach(projectId => {
                if (projectId !== currentProjectId && !projects[projectId].isClosed) {
                    const listItem = document.createElement('li');
                    listItem.textContent = projects[projectId].name;
                    listItem.setAttribute('data-project-id', projectId);
                    listItem.onclick = () => selectComparisonProject(projectId);
                    comparisonProjectList.appendChild(listItem);
                }
            });
        }

        function selectComparisonProject(projectId) {
            comparisonProjectId = projectId;
            closeProjectSelectionModal();
            const metricDisplayName = stagesConfig[currentMetricTypeForModal.sectionId]?.metrics[currentMetricTypeForModal.metricId]?.name || 'מדד';
            openHistoryModal(currentMetricTypeForModal.sectionId, currentMetricTypeForModal.metricId, metricDisplayName);
        }

        function checkReminders() {
            const now = new Date();
            reminders.forEach(reminder => {
                const reminderTime = new Date(reminder.datetime);
                if (reminderTime <= now && !reminder.notified) {
                    reminder.notified = true;
                    if (reminder.popup && 'Notification' in window && Notification.permission === 'granted') {
                        new Notification(reminder.text);
                    }
                    inbox.push(reminder);
                    renderInboxList();
                }
            });
            localStorage.setItem('reminders', JSON.stringify(reminders));
            localStorage.setItem('inbox', JSON.stringify(inbox));
            renderRemindersList();
        }

        function addReminder() {
            const text = reminderTextInput.value.trim();
            const datetime = reminderDateTimeInput.value;
            const popup = reminderPopupInput.checked;
            if (text && datetime) {
                reminders.push({ id: Date.now(), text, datetime, popup, notified: false });
                localStorage.setItem('reminders', JSON.stringify(reminders));
                reminderTextInput.value = '';
                reminderDateTimeInput.value = '';
                reminderPopupInput.checked = false;
                renderRemindersList();
                checkReminders();
            } else {
                alert('אנא הזן טקסט ותאריך/שעה.');
            }
        }

        function renderRemindersList() {
            remindersList.innerHTML = '';
            reminders.forEach(reminder => {
                if (!reminder.notified) {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="reminder-details">
                            <div class="text">${reminder.text}</div>
                            <div class="datetime">${new Date(reminder.datetime).toLocaleString('he-IL')}</div>
                        </div>
                        <div class="reminder-actions">
                            <button onclick="deleteReminder(${reminder.id})">מחק</button>
                        </div>
                    `;
                    remindersList.appendChild(li);
                }
            });
        }

        function deleteReminder(id) {
            reminders = reminders.filter(r => r.id !== id);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            renderRemindersList();
        }

        function openInboxModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            inboxModal.style.display = 'flex';
            renderInboxList();
        }

        function closeInboxModal() {
            inboxModal.style.display = 'none';
            showMainContent();
        }

        function renderInboxList() {
            inboxList.innerHTML = '';
            inbox.forEach(reminder => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="reminder-details">
                        <div class="text">${reminder.text}</div>
                        <div class="datetime">${new Date(reminder.datetime).toLocaleString('he-IL')}</div>
                    </div>
                    <div class="reminder-actions">
                        <button onclick="deleteInbox(${reminder.id})">מחק</button>
                    </div>
                `;
                inboxList.appendChild(li);
            });
        }

        function deleteInbox(id) {
            inbox = inbox.filter(r => r.id !== id);
            localStorage.setItem('inbox', JSON.stringify(inbox));
            renderInboxList();
        }

        function openRemindersModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            remindersModal.style.display = 'flex';
            renderRemindersList();
        }

        function closeRemindersModal() {
            remindersModal.style.display = 'none';
            showMainContent();
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('הודעות מאושרות.');
                    }
                });
            }
        }

        window.onload = () => {
            loadDarkModeState();
            populateYearSelects();
            setDefaultYearFilter();
            renderAllMainContent();
            requestNotificationPermission();
            setInterval(checkReminders, 60000); // Check every minute
            checkReminders();
        };

        function setDefaultYearFilter() {
            const currentYear = new Date().getFullYear().toString();
            projectYearFilter.value = 'all';
            filterProjectsByYear();
        }

        function renderAllMainContent() {
            updateProjectDisplay();
            renderStageNavigation();
        }

        function loadDarkModeState() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
            }
        }

        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'true');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
            }
        });

        projectYearFilter.addEventListener('change', filterProjectsByYear);

        hamburgerBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        function toggleSidebar() {
            hamburgerBtn.classList.toggle('open');
            sidebar.classList.toggle('open');
            sidebarOverlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
        }

        function closeSidebar() {
            hamburgerBtn.classList.remove('open');
            sidebar.classList.remove('open');
            sidebarOverlay.style.display = 'none';
        }

        function showMainContent() {
            historyModal.style.display = 'none';
            projectManagementModal.style.display = 'none';
            financeModal.style.display = 'none';
            currentProjectFinanceReportModal.style.display = 'none';
            globalFinanceReportModal.style.display = 'none';
            financeYearlyModal.style.display = 'none';
            inboxModal.style.display = 'none';
            remindersModal.style.display = 'none';
            instructionsModal.style.display = 'none';
            timelineModal.style.display = 'none';
            datePickerModal.style.display = 'none';
            projectSelectionModal.style.display = 'none';

            document.querySelector('.container').style.display = 'block';
            document.querySelector('.top-section-wrapper').style.display = 'block';
            currentStageContent.style.display = 'block';
            stageNavContainer.style.display = 'flex';
            projectDetailsCard.style.display = 'block';
            fixedDashboardSection.style.display = 'flex';

            const stageOrder = Object.keys(stagesConfig);
            const currentStageIndex = stageOrder.indexOf(currentStageId);
            if (currentStageIndex > 0) {
                stageOverviewContainer.style.display = 'block';
            } else {
                stageOverviewContainer.style.display = 'none';
            }
        }

        function createNewProjectData(name) {
            const newProject = {
                name: name,
                isClosed: false,
                wineDetails: {
                    customProperties: []
                },
                stages: {},
                finance: []
            };
            for(const metricId in stagesConfig.wineDetails.metrics) {
                newProject.wineDetails[metricId] = [];
            }
            for (const stageId in stagesConfig) {
                if (stageId === 'wineDetails') continue;
                newProject.stages[stageId] = {};
                for (const metricId in stagesConfig[stageId].metrics) {
                    newProject.stages[stageId][metricId] = [];
                }
            }
            return newProject;
        }

        function loadProjects() {
            const storedProjects = localStorage.getItem('projects');
            let loaded = storedProjects ? JSON.parse(storedProjects) : {};
            if (Object.keys(loaded).length === 0) {
                loaded['default_project'] = createNewProjectData('פרויקט ראשי');
            }
            for (const projectId in loaded) {
                const project = loaded[projectId];
                if (project.isClosed === undefined) project.isClosed = false;
                if (!project.wineDetails) {
                    project.wineDetails = {};
                    const oldStage7 = project.stages && project.stages['stage7'];
                    if (oldStage7) {
                        if (oldStage7.wineName && oldStage7.wineName.length > 0) project.wineDetails.wineName = oldStage7.wineName;
                        if (oldStage7.vintageYear && oldStage7.vintageYear.length > 0) project.wineDetails.vintageYear = oldStage7.vintageYear;
                        if (oldStage7.generalNotes && oldStage7.generalNotes.length > 0) project.wineDetails.generalNotes = oldStage7.generalNotes;
                    }
                    const oldStage1 = project.stages && project.stages['stage1'];
                     if (oldStage1) {
                        if (oldStage1.harvestDate && oldStage1.harvestDate.length > 0) project.wineDetails.harvestDate = oldStage1.harvestDate;
                        if (oldStage1.grapeVariety && oldStage1.grapeVariety.length > 0) project.wineDetails.grapeVariety = oldStage1.grapeVariety;
                        if (oldStage1.vineyardSource && oldStage1.vineyardSource.length > 0) project.wineDetails.vineyardSource = oldStage1.vineyardSource;
                    }
                }
                for(const metricId in stagesConfig.wineDetails.metrics) {
                    if (!project.wineDetails[metricId]) {
                        project.wineDetails[metricId] = [];
                    }
                }
                if (!project.wineDetails.customProperties) {
                    project.wineDetails.customProperties = [];
                }
                if (!project.finance) {
                    project.finance = project.expenses || [];
                    if (project.expenses) delete project.expenses;
                }
                if (!project.stages) {
                    project.stages = {};
                }
                for (const stageId in stagesConfig) {
                    if (stageId === 'wineDetails') continue;
                    if (!project.stages[stageId]) {
                        project.stages[stageId] = {};
                    }
                    for (const metricId in stagesConfig[stageId].metrics) {
                        if (!project.stages[stageId][metricId]) {
                            project.stages[stageId][metricId] = [];
                        }
                    }
                }
                if (project.stages && project.stages['stage7'] && !stagesConfig['stage7']) {
                    delete project.stages['stage7'];
                }
            }
            return loaded;
        }

        function saveAllProjects() {
            localStorage.setItem('projects', JSON.stringify(projects));
            if (auth.currentUser) {
                saveStateToFirebase();
            }
        }

        function updateProjectDisplay() {
            currentProjectNameDisplay.textContent = projects[currentProjectId].name;
            editProjectNameInput.value = projects[currentProjectId].name;
            loadCurrentStageContent();
            updateProjectDetailsCard();
        }

        function openProjectManagementModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            projectManagementModal.style.display = 'flex';
            filterProjectsByYear();
        }

        function closeProjectManagementModal() {
            projectManagementModal.style.display = 'none';
            showMainContent();
        }

        function filterProjectsByYear() {
            const selectedYear = projectYearFilter.value;
            renderProjectList(selectedYear);
        }

        function renderProjectList(yearFilter = 'all') {
            projectList.innerHTML = '';
            let projectsToDisplay = Object.keys(projects).map(id => ({ id, ...projects[id] }));
            if (yearFilter !== 'all') {
                projectsToDisplay = projectsToDisplay.filter(project => {
                    const vintageYearEntries = project.wineDetails.vintageYear;
                    if (vintageYearEntries && vintageYearEntries.length > 0) {
                        const latestYear = vintageYearEntries[vintageYearEntries.length - 1].value;
                        return latestYear == yearFilter;
                    }
                    return false;
                });
                // then display as before
            } else {
                // group by years
                const yearGroups = {};
                projectsToDisplay.forEach(project => {
                    const vintageYearEntries = project.wineDetails.vintageYear;
                    const year = vintageYearEntries && vintageYearEntries.length > 0 ? vintageYearEntries[vintageYearEntries.length - 1].value : 'לא צוין';
                    if (!yearGroups[year]) yearGroups[year] = [];
                    yearGroups[year].push(project);
                });
                const sortedYears = Object.keys(yearGroups).sort((a,b) => {
                    if (a === 'לא צוין') return 1;
                    if (b === 'לא צוין') return -1;
                    return b - a; // descending
                });
                sortedYears.forEach(year => {
                    const yearHeader = document.createElement('h3');
                    yearHeader.textContent = year === 'לא צוין' ? 'שנים לא צוינו' : `שנה ${year}`;
                    yearHeader.style.color = 'var(--primary-color)';
                    yearHeader.style.borderBottom = '2px solid var(--border-color)';
                    yearHeader.style.paddingBottom = '10px';
                    yearHeader.style.marginBottom = '10px';
                    projectList.appendChild(yearHeader);
                    yearGroups[year].sort((a,b) => a.name.localeCompare(b.name)).forEach(project => {
                        const listItem = document.createElement('li');
                        listItem.setAttribute('data-project-id', project.id);
                        if (project.id === currentProjectId) {
                            listItem.classList.add('active-project');
                        }
                        if (project.isClosed) {
                            listItem.classList.add('closed');
                        }
                        const vintageYearEntries = project.wineDetails.vintageYear;
                        const year = vintageYearEntries && vintageYearEntries.length > 0 ? vintageYearEntries[vintageYearEntries.length - 1].value : 'לא צוין';
                        listItem.innerHTML = `
                            <span>${project.name} (${year})</span>
                            <div class="project-actions">
                                <button onclick="switchProject('${project.id}')">${project.id === currentProjectId ? 'נוכחי' : 'בחר'}</button>
                                <button class="close-project" onclick="toggleProjectClosed('${project.id}')">${project.isClosed ? 'פתח' : 'סגור'}</button>
                                ${project.id !== 'default_project' || Object.keys(projects).length > 1 ? `<button class="delete" onclick="deleteProject('${project.id}')">מחק</button>` : ''}
                            </div>
                        `;
                        projectList.appendChild(listItem);
                    });
                });
                return;
            }
            projectsToDisplay.sort((a, b) => a.name.localeCompare(b.name)).forEach(project => {
                const listItem = document.createElement('li');
                listItem.setAttribute('data-project-id', project.id);
                if (project.id === currentProjectId) {
                    listItem.classList.add('active-project');
                }
                if (project.isClosed) {
                    listItem.classList.add('closed');
                }
                const vintageYearEntries = project.wineDetails.vintageYear;
                const year = vintageYearEntries && vintageYearEntries.length > 0 ? vintageYearEntries[vintageYearEntries.length - 1].value : 'לא צוין';
                listItem.innerHTML = `
                    <span>${project.name} (${year})</span>
                    <div class="project-actions">
                        <button onclick="switchProject('${project.id}')">${project.id === currentProjectId ? 'נוכחי' : 'בחר'}</button>
                        <button class="close-project" onclick="toggleProjectClosed('${project.id}')">${project.isClosed ? 'פתח' : 'סגור'}</button>
                        ${project.id !== 'default_project' || Object.keys(projects).length > 1 ? `<button class="delete" onclick="deleteProject('${project.id}')">מחק</button>` : ''}
                    </div>
                `;
                projectList.appendChild(listItem);
            });
        }

        function toggleProjectClosed(projectId) {
            projects[projectId].isClosed = !projects[projectId].isClosed;
            saveAllProjects();
            filterProjectsByYear();
        }

        function addNewProject() {
            if (!auth.currentUser) {
                alert('כדי ליצור פרויקט חדש, יש להתחבר עם Google.');
                return;
            }
            let newProjectName = prompt('הכנס שם לפרויקט החדש:');
            if (newProjectName && newProjectName.trim() !== '') {
                newProjectName = newProjectName.trim();
                const newProjectId = `project_${Date.now()}`;
                projects[newProjectId] = createNewProjectData(newProjectName);
                saveAllProjects();
                switchProject(newProjectId);
                filterProjectsByYear();
            }
        }

        function switchProject(id) {
            if (projects[id].isClosed) {
                alert('לא ניתן לעבוד על פרויקט סגור. פתח אותו קודם.');
                return;
            }
            currentProjectId = id;
            localStorage.setItem('currentProjectId', currentProjectId);
            loadCurrentStageContent();
            updateProjectDisplay();
            closeProjectManagementModal();
        }

        function deleteProject(id) {
            if (confirm('האם אתה בטוח שברצונך למחוק את הפרויקט "${projects[id].name}"? כל הנתונים יימחקו לצמיתות.')) {
                delete projects[id];
                if (currentProjectId === id) {
                    const remainingProjects = Object.keys(projects).filter(pid => !projects[pid].isClosed);
                    if (remainingProjects.length > 0) {
                        currentProjectId = remainingProjects[0];
                    } else {
                        currentProjectId = Object.keys(projects)[0];
                        if (!currentProjectId) {
                             currentProjectId = 'default_project';
                             projects[currentProjectId] = createNewProjectData('פרויקט ראשי');
                        }
                    }
                }
                saveAllProjects();
                localStorage.setItem('currentProjectId', currentProjectId);
                updateProjectDisplay();
                filterProjectsByYear();
            }
        }

        currentProjectNameDisplay.addEventListener('click', editProjectName);

        function editProjectName() {
            currentProjectNameDisplay.style.display = 'none';
            editProjectNameInput.style.display = 'inline-block';
            editProjectNameInput.focus();
            editProjectNameInput.select();
            if (!editProjectNameInput._eventListenersAdded) {
                editProjectNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        saveProjectName();
                    }
                });
                editProjectNameInput.addEventListener('blur', saveProjectName);
                editProjectNameInput._eventListenersAdded = true;
            }
        }

        function saveProjectName() {
            const newName = editProjectNameInput.value.trim();
            if (newName !== '' && newName !== projects[currentProjectId].name) {
                projects[currentProjectId].name = newProjectName;
                saveAllProjects();
                updateProjectDisplay();
            }
            currentProjectNameDisplay.style.display = 'inline-block';
            editProjectNameInput.style.display = 'none';
        }

        function renderStageNavigation() {
            stageNavContainer.innerHTML = '';
            const stageOrder = Object.keys(stagesConfig).filter(id => id !== 'wineDetails');
            const leftSideStages = stageOrder.slice(0, 3);
            const rightSideStages = stageOrder.slice(3, 6);
            const leftDiv = document.createElement('div');
            const rightDiv = document.createElement('div');
            leftSideStages.forEach(stageId => {
                const stage = stagesConfig[stageId];
                const button = document.createElement('button');
                button.className = 'stage-nav-button';
                button.textContent = `${stage.longName}`;
                button.onclick = () => switchStage(stageId);
                if (stageId === currentStageId) {
                    button.classList.add('active');
                }
                leftDiv.appendChild(button);
            });
            const wineIconContainer = document.createElement('div');
            wineIconContainer.className = 'wine-icon-container';
            const wineIconLink = document.createElement('a');
            wineIconLink.href = "#";
            wineIconLink.onclick = (e) => { e.preventDefault(); };
            const wineIconImg = document.createElement('img');
            wineIconImg.src = "image_00b206.png";
            wineIconImg.alt = "Wine Icon";
            wineIconLink.appendChild(wineIconImg);
            wineIconContainer.appendChild(wineIconLink);
            rightSideStages.forEach(stageId => {
                const stage = stagesConfig[stageId];
                const button = document.createElement('button');
                button.className = 'stage-nav-button';
                button.textContent = `${stage.longName}`;
                button.onclick = () => switchStage(stageId);
                if (stageId === currentStageId) {
                    button.classList.add('active');
                }
                rightDiv.appendChild(button);
            });
            stageNavContainer.appendChild(leftDiv);
            stageNavContainer.appendChild(wineIconContainer);
            stageNavContainer.appendChild(rightDiv);
        }

        function switchStage(stageId) {
            currentStageId = stageId;
            localStorage.setItem('currentStageId', currentStageId);
            renderStageNavigation();
            loadCurrentStageContent();
        }

        function loadCurrentStageContent() {
            if (projects[currentProjectId].isClosed) {
                alert('הפרויקט סגור. פתח אותו כדי לעבוד עליו.');
                return;
            }
            const stageConfig = stagesConfig[currentStageId];
            if (!stageConfig || currentStageId === 'wineDetails') {
                console.error("Invalid or special stage for main content:", currentStageId);
                currentStageId = Object.keys(stagesConfig).find(id => id !== 'wineDetails');
                if (!currentStageId) {
                    return;
                }
                localStorage.setItem('currentStageId', currentStageId);
                renderStageNavigation();
                loadCurrentStageContent();
                return;
            }
            fixedDashboardStageName.textContent = `${stageConfig.longName}`;
            currentStageInputSection.innerHTML = '';
            for (const metricId in stageConfig.metrics) {
                const metric = stageConfig.metrics[metricId];
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                let inputElementHTML = '';
                if (metric.type === 'select') {
                    inputElementHTML = `<select id="${metricId}Input">`;
                    inputElementHTML += `<option value="" disabled selected>${metric.placeholder}</option>`;
                    metric.options.forEach(option => {
                        inputElementHTML += `<option value="${option}">${option}</option>`;
                    });
                    inputElementHTML += `<option value="other_input_field">אחר...</option>`;
                    inputElementHTML += `</select>`;
                    inputElementHTML += `<input type="text" id="${metricId}OtherInput" placeholder="הכנס זן אחר" style="display:none; margin-top: 5px;">`;
                } else if (metric.type === 'date') {
                    inputElementHTML = `<input type="text" id="${metricId}Input" placeholder="${metric.placeholder || ''}" readonly>`;
                } else {
                    inputElementHTML = `<input type="${metric.type}" id="${metricId}Input" ${metric.type === 'number' ? `step="${metric.step}"` : ''} placeholder="${metric.placeholder || ''}">`;
                }
                inputGroup.innerHTML = `
                    <label for="${metricId}Input">${metric.name}:</label>
                    ${inputElementHTML}
                    <button onclick="updateMetricValue('${currentStageId}', '${metricId}')">עדכן</button>
                `;
                currentStageInputSection.appendChild(inputGroup);
                if (metric.type === 'select') {
                    const selectElement = document.getElementById(`${metricId}Input`);
                    const otherInput = document.getElementById(`${metricId}OtherInput`);
                    if (selectElement && otherInput) {
                        selectElement.addEventListener('change', () => {
                            if (selectElement.value === 'other_input_field') {
                                otherInput.style.display = 'block';
                                otherInput.focus();
                            } else {
                                otherInput.style.display = 'none';
                                otherInput.value = '';
                            }
                        });
                    }
                }
                if (metric.type === 'date') {
                    const dateInput = document.getElementById(`${metricId}Input`);
                    if (dateInput) {
                        dateInput.addEventListener('click', () => {
                            showDatePicker(dateInput.value, (selectedDate) => {
                                dateInput.value = selectedDate;
                            });
                        });
                    }
                }
            }
            updateDashboardForCurrentStage();
            renderPreviousStageOverview();
        }

        function updateMetricValue(stageId, metricId) {
            let inputElement;
            let value;
            const metricConfig = stagesConfig[stageId].metrics[metricId];
            if (metricConfig.type === 'select') {
                inputElement = document.getElementById(`${metricId}Input`);
                if (inputElement.value === 'other_input_field') {
                    const otherInput = document.getElementById(`${metricId}OtherInput`);
                    value = otherInput.value.trim();
                } else {
                    value = inputElement.value;
                }
            } else {
                inputElement = document.getElementById(`${metricId}Input`);
                value = inputElement.value;
            }
            if (metricConfig.type === 'number') {
                value = parseFloat(value);
                if (isNaN(value)) {
                    alert('אנא הזן ערך מספרי תקין.');
                    return;
                }
            } else if (value === '') {
                alert('אנא הזן ערך.');
                return;
            }
            const timestamp = new Date().toLocaleString('he-IL', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
            if (!projects[currentProjectId].stages[stageId] || !projects[currentProjectId].stages[stageId][metricId]) {
                if (!projects[currentProjectId].stages[stageId]) {
                    projects[currentProjectId].stages[stageId] = {};
                }
                projects[currentProjectId].stages[stageId][metricId] = [];
            }
            projects[currentProjectId].stages[stageId][metricId].push({ value, timestamp });
            saveAllProjects();
            if (metricConfig.type === 'select') {
                inputElement.value = "";
                const otherInput = document.getElementById(`${metricId}OtherInput`);
                if (otherInput) {
                    otherInput.value = '';
                    otherInput.style.display = 'none';
                }
            } else {
                inputElement.value = '';
            }
            updateDashboardForCurrentStage();
            renderPreviousStageOverview();
        }

        function updateDashboardForCurrentStage() {
            fixedDashboardGrid.innerHTML = '';
            const stageMetrics = stagesConfig[currentStageId].metrics;
            for (const metricId in stageMetrics) {
                const metricConfig = stageMetrics[metricId];
                const currentEntries = projects[currentProjectId].stages[currentStageId][metricId];
                const displayValue = currentEntries && currentEntries.length > 0
                    ? (metricConfig.type === 'number' ? currentEntries[currentEntries.length - 1].value.toFixed(metricConfig.precision) : currentEntries[currentEntries.length - 1].value)
                    : '--';
                const dashboardItem = document.createElement('div');
                dashboardItem.className = 'dashboard-item';
                dashboardItem.setAttribute('onclick', `openHistoryModal('${currentStageId}', '${metricId}', '${metricConfig.name}')`);
                dashboardItem.innerHTML = `
                    <h3>${metricConfig.name}</h3>
                    <p>${displayValue}</p>
                `;
                fixedDashboardGrid.appendChild(dashboardItem);
            }
        }

        function openHistoryModal(sectionId, metricId, metricName) {
            currentMetricTypeForModal = { sectionId, metricId };
            modalTitle.textContent = `היסטוריית ${metricName} (${stagesConfig[sectionId].name})`;
            historyList.innerHTML = '';
            modalGraphSvg.innerHTML = '';
            let metricConfig;
            let historyEntries;
            if (sectionId === 'wineDetails') {
                metricConfig = stagesConfig.wineDetails.metrics[metricId];
                if (metricConfig) {
                    historyEntries = projects[currentProjectId].wineDetails[metricId];
                } else {
                    const customProp = projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId);
                    if (customProp) {
                        historyEntries = customProp.history;
                        metricConfig = { name: customProp.name, type: 'text' };
                        if (historyEntries.every(entry => typeof entry.value === 'number')) {
                            metricConfig.type = 'number';
                            metricConfig.precision = 2;
                        }
                    }
                }
            } else {
                metricConfig = stagesConfig[sectionId].metrics[metricId];
                historyEntries = projects[currentProjectId].stages[sectionId][metricId];
            }
            const precision = metricConfig ? metricConfig.precision : null;
            if (metricConfig && metricConfig.type === 'number' && historyEntries && historyEntries.length > 0) {
                modalGraphSvg.style.display = 'block';
                historyModal.style.display = 'flex';
                setTimeout(() => {
                    drawModalGraph(historyEntries, precision);
                }, 50);
            } else {
                modalGraphSvg.style.display = 'none';
                historyModal.style.display = 'flex';
            }
            if (historyEntries && historyEntries.length > 0) {
                historyEntries.slice().reverse().forEach((entry, index) => {
                    const originalIndex = historyEntries.length - 1 - index;
                    const listItem = document.createElement('li');
                    let displayValue;
                    if (metricConfig && metricConfig.type === 'number') {
                        displayValue = entry.value.toFixed(precision);
                    } else {
                        displayValue = entry.value;
                    }
                    listItem.innerHTML = `
                        <strong>${displayValue}</strong>
                        <span class="timestamp">${entry.timestamp}</span>
                        <button class="undo-button" onclick="undoUpdate('${sectionId}', '${metricId}', ${originalIndex})">בטל</button>
                    `;
                    historyList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'אין נתונים היסטוריים זמינים.';
                historyList.appendChild(listItem);
            }
        }

        function drawModalGraph(entries, precision) {
            modalGraphSvg.innerHTML = '';
            if (entries.length < 1) {
                return;
            }
            const svgWidth = modalGraphSvg.clientWidth;
            const svgHeight = modalGraphSvg.clientHeight;
            const paddingTop = 25;
            const paddingBottom = 40;
            const paddingLeft = 40;
            const paddingRight = 10;
            const graphWidth = svgWidth - paddingLeft - paddingRight;
            const graphHeight = svgHeight - paddingTop - paddingBottom;
            let values = entries.map(e => e.value);
            let minValue = Math.min(...values);
            let maxValue = Math.max(...values);
            let averageValue = values.reduce((sum, val) => sum + val, 0) / values.length;
            if (entries.length === 1 || minValue === maxValue) {
                const buffer = (values[0] * 0.1) || 1;
                minValue = values[0] - buffer;
                maxValue = values[0] + buffer;
                if (minValue === maxValue) {
                     minValue -= 0.5;
                     maxValue += 0.5;
                }
            }
            let comparisonEntries = null;
            if (comparisonProjectId && projects[comparisonProjectId]) {
                let compHistoryEntries;
                if (currentMetricTypeForModal.sectionId === 'wineDetails') {
                    compHistoryEntries = projects[comparisonProjectId].wineDetails[currentMetricTypeForModal.metricId];
                } else {
                    compHistoryEntries = projects[comparisonProjectId].stages[currentMetricTypeForModal.sectionId][currentMetricTypeForModal.metricId];
                }
                if (compHistoryEntries && compHistoryEntries.length > 0) {
                    comparisonEntries = compHistoryEntries;
                    const compValues = compHistoryEntries.map(e => e.value);
                    minValue = Math.min(minValue, ...compValues);
                    maxValue = Math.max(maxValue, ...compValues);
                    values = values.concat(compValues);
                    averageValue = values.reduce((sum, val) => sum + val, 0) / values.length;
                }
            }
            const valueRange = maxValue - minValue;
            const xScale = (index) => paddingLeft + (index / (entries.length - 1 || 1)) * graphWidth;
            const yScale = (value) => graphHeight - ((value - minValue) / valueRange) * graphHeight + paddingTop;
            const numYLabels = 3;
            for (let i = 0; i < numYLabels; i++) {
                const valueAtY = minValue + (i / (numYLabels - 1)) * valueRange;
                const yPos = yScale(valueAtY);
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', paddingLeft);
                line.setAttribute('y1', yPos);
                line.setAttribute('x2', svgWidth - paddingRight);
                line.setAttribute('y2', yPos);
                line.classList.add('modal-graph-grid-line');
                modalGraphSvg.appendChild(line);
                const textY = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                textY.setAttribute('x', paddingLeft - 5);
                textY.setAttribute('y', yPos + 3);
                textY.classList.add('modal-graph-label-y');
                textY.textContent = valueAtY.toFixed(precision);
                modalGraphSvg.appendChild(textY);
            }
            let linePath = '';
            let areaPath = `M ${paddingLeft} ${yScale(minValue)}`;
            entries.forEach((entry, i) => {
                const x = xScale(i);
                const y = yScale(entry.value);
                if (i === 0) {
                    linePath += `M ${x} ${y}`;
                } else {
                    linePath += `L ${x} ${y}`;
                }
                areaPath += `L ${x} ${y}`;
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', 5);
                circle.classList.add('modal-graph-point');
                circle.setAttribute('data-value', entry.value.toFixed(precision));
                circle.setAttribute('data-timestamp', entry.timestamp);
                modalGraphSvg.appendChild(circle);
                const datePart = entry.timestamp.split(',')[0];
                const timePart = entry.timestamp.split(',')[1] ? entry.timestamp.split(',')[1].trim() : '';
                const interval = Math.ceil(entries.length / 5);
                if (entries.length <= 2 || i % interval === 0 || i === entries.length - 1) {
                    const textX = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textX.setAttribute('x', x);
                    textX.setAttribute('y', svgHeight - paddingBottom + 10);
                    textX.classList.add('modal-graph-label-x');
                    const tspanDate = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                    tspanDate.setAttribute('x', x);
                    tspanDate.setAttribute('dy', '0em');
                    tspanDate.textContent = datePart;
                    textX.appendChild(tspanDate);
                    if (timePart) {
                        const tspanTime = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                        tspanTime.setAttribute('x', x);
                        tspanTime.setAttribute('dy', '1.2em');
                        tspanTime.textContent = timePart;
                        textX.appendChild(tspanTime);
                    }
                    textX.setAttribute('transform', `rotate(-45 ${x}, ${svgHeight - paddingBottom + 10})`);
                    modalGraphSvg.appendChild(textX);
                }
            });
            areaPath += `L ${xScale(entries.length - 1)} ${yScale(minValue)} L ${paddingLeft} ${yScale(minValue)} Z`;
            const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            area.setAttribute('d', areaPath);
            area.classList.add('modal-graph-area-path');
            modalGraphSvg.appendChild(area);
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', linePath);
            path.classList.add('modal-graph-line-path');
            modalGraphSvg.appendChild(path);
            const pathLength = path.getTotalLength();
            path.style.strokeDasharray = `${pathLength} ${pathLength}`;
            path.style.strokeDashoffset = pathLength;
            setTimeout(() => {
                path.style.strokeDashoffset = 0;
            }, 100);
            if (comparisonEntries) {
                let compLinePath = '';
                let compAreaPath = `M ${paddingLeft} ${yScale(minValue)}`;
                comparisonEntries.forEach((entry, i) => {
                    const x = paddingLeft + (i / (comparisonEntries.length - 1 || 1)) * graphWidth;
                    const y = yScale(entry.value);
                    if (i === 0) {
                        compLinePath += `M ${x} ${y}`;
                    } else {
                        compLinePath += `L ${x} ${y}`;
                    }
                    compAreaPath += `L ${x} ${y}`;
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', y);
                    circle.setAttribute('r', 4);
                    circle.setAttribute('fill', '#FF6347');
                    circle.setAttribute('stroke', '#fff');
                    circle.setAttribute('stroke-width', '2');
                    circle.setAttribute('data-value', entry.value.toFixed(precision));
                    circle.setAttribute('data-timestamp', entry.timestamp);
                    modalGraphSvg.appendChild(circle);
                });
                compAreaPath += `L ${paddingLeft + ((comparisonEntries.length - 1) / (comparisonEntries.length - 1 || 1)) * graphWidth} ${yScale(minValue)} L ${paddingLeft} ${yScale(minValue)} Z`;
                const compArea = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                compArea.setAttribute('d', compAreaPath);
                compArea.setAttribute('fill', 'rgba(255, 99, 71, 0.2)');
                compArea.setAttribute('opacity', '0.8');
                modalGraphSvg.appendChild(compArea);
                const compPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                compPath.setAttribute('d', compLinePath);
                compPath.setAttribute('fill', 'none');
                compPath.setAttribute('stroke', '#FF6347');
                compPath.setAttribute('stroke-width', '3');
                modalGraphSvg.appendChild(compPath);
            }
            const avgY = yScale(averageValue);
            const avgLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            avgLine.setAttribute('x1', paddingLeft);
            avgLine.setAttribute('y1', avgY);
            avgLine.setAttribute('x2', svgWidth - paddingRight);
            avgLine.setAttribute('y2', avgY);
            avgLine.classList.add('modal-graph-average-line');
            modalGraphSvg.appendChild(avgLine);
            const avgLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            avgLabel.setAttribute('x', svgWidth - paddingRight + 5);
            avgLabel.setAttribute('y', avgY + 3);
            avgLabel.classList.add('modal-graph-average-label');
            avgLabel.textContent = `ממוצע: ${averageValue.toFixed(precision)}`;
            modalGraphSvg.appendChild(avgLabel);
            // Add zoom behavior
            const zoom = d3.zoom().scaleExtent([0.5, 5]).on('zoom', (event) => {
                const transform = event.transform;
                modalGraphSvg.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.k})`;
            });
            d3.select(modalGraphSvg).call(zoom);
        }

        function closeHistoryModal() {
            historyModal.style.display = 'none';
            comparisonProjectId = null;
        }

        function undoUpdate(sectionId, metricId, indexToRemove) {
            if (!confirm('האם אתה בטוח שברצונך לבטל את העדכון הזה?')) {
                return;
            }
            let metricDataArray;
            if (sectionId === 'wineDetails') {
                const predefinedMetricConfig = stagesConfig.wineDetails.metrics[metricId];
                if (predefinedMetricConfig) {
                    metricDataArray = projects[currentProjectId].wineDetails[metricId];
                } else {
                    const customProp = projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId);
                    if (customProp) {
                        metricDataArray = customProp.history;
                    } else {
                        console.error("Attempted to undo for non-existent custom property or metric:", metricId);
                        return;
                    }
                }
            } else {
                metricDataArray = projects[currentProjectId].stages[sectionId][metricId];
            }
            if (metricDataArray) {
                metricDataArray.splice(indexToRemove, 1);
                saveAllProjects();
                if (sectionId === 'wineDetails') {
                    updateProjectDetailsCard();
                } else {
                    updateDashboardForCurrentStage();
                    renderPreviousStageOverview();
                }
                if (currentMetricTypeForModal.sectionId === sectionId && currentMetricTypeForModal.metricId === metricId) {
                    const metricDisplayName = (sectionId === 'wineDetails' && !stagesConfig.wineDetails.metrics[metricId])
                                            ? projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId).name
                                            : stagesConfig[sectionId].metrics[metricId].name;
                    openHistoryModal(sectionId, metricId, metricDisplayName);
                }
            } else {
                console.warn(`Attempted to undo for non-existent path: project: ${currentProjectId}, stage/section: ${sectionId}, metric: ${metricId}`);
                alert("שגיאה: לא ניתן לבטל. ייתכן שהנתונים אינם קיימים.");
            }
        }

        function openFinanceModal() {
            if (projects[currentProjectId].isClosed) {
                alert('הפרויקט סגור. פתח אותו כדי לנהל כספים.');
                return;
            }
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            financeModal.style.display = 'flex';
            renderFinanceList();
        }

        function closeFinanceModal() {
            financeModal.style.display = 'none';
            showMainContent();
        }

        function addFinanceEntry(type) {
            const amount = parseFloat(financeAmountInput.value);
            const notes = financeNotesInput.value.trim();
            if (isNaN(amount) || amount <= 0) {
                alert('אנא הזן סכום חוקי (חיובי) עבור התנועה.');
                return;
            }
            const timestamp = new Date().toLocaleString('he-IL', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
            projects[currentProjectId].finance.push({ id: Date.now(), type, amount, notes, timestamp });
            saveAllProjects();
            financeAmountInput.value = '';
            financeNotesInput.value = '';
            renderFinanceList();
        }

        function renderFinanceList() {
            financeList.innerHTML = '';
            let balance = 0;
            const sortedEntries = projects[currentProjectId].finance.slice().sort((a, b) => {
                const parseDateString = (ts) => {
                    const parts = ts.match(/(\d{2})\/(\d{2})\/(\d{4})(?:, (\d{2}):(\d{2}):(\d{2}))?/);
                    if (parts) {
                        const year = parseInt(parts[3], 10);
                        const month = parseInt(parts[2], 10) - 1;
                        const day = parseInt(parts[1], 10);
                        const hour = parseInt(parts[4] || 0, 10);
                        const minute = parseInt(parts[5] || 0, 10);
                        const second = parseInt(parts[6] || 0, 10);
                        return new Date(year, month, day, hour, minute, second);
                    }
                    return new Date(ts);
                };
                const dateA = parseDateString(a.timestamp);
                const dateB = parseDateString(b.timestamp);
                return dateB.getTime() - dateA.getTime();
            });
            sortedEntries.forEach(entry => {
                const listItem = document.createElement('li');
                listItem.setAttribute('data-finance-id', entry.id);
                const displayAmount = (entry.type === 'expense' ? '-' : '+') + entry.amount.toFixed(2);
                const amountClass = entry.type;
                listItem.innerHTML = `
                    <div class="finance-item-details">
                        <span class="amount ${amountClass}">${displayAmount} ₪</span>
                        <div class="notes">${entry.notes || 'אין הערות'}</div>
                        <span class="timestamp" style="font-size:0.8em; color:var(--light-text-color);">${entry.timestamp}</span>
                    </div>
                    <div class="finance-item-actions">
                        <button onclick="editFinanceEntry(${entry.id})">ערוך</button>
                        <button class="delete" onclick="deleteFinanceEntry(${entry.id})">מחק</button>
                    </div>
                `;
                financeList.appendChild(listItem);
                if (entry.type === 'income') {
                    balance += entry.amount;
                } else {
                    balance -= entry.amount;
                }
            });
            if (financeList.children.length === 0) {
                const listItem = document.createElement('li');
                listItem.textContent = 'אין תנועות כספיות תואמות בפרויקט זה.';
                financeList.appendChild(listItem);
            }
            currentBalanceDisplay.textContent = balance.toFixed(2);
            currentBalanceDisplay.classList.remove('positive', 'negative');
            if (balance > 0) {
                currentBalanceDisplay.classList.add('positive');
            } else if (balance < 0) {
                currentBalanceDisplay.classList.add('negative');
            }
        }

        function editFinanceEntry(id) {
            const entry = projects[currentProjectId].finance.find(e => e.id === id);
            if (!entry) return;
            let newAmount = prompt(`ערוך סכום (${entry.type === 'income' ? 'הכנסה' : 'הוצאה'}):`, entry.amount);
            if (newAmount === null) return;
            newAmount = parseFloat(newAmount);
            let newNotes = prompt('ערוך הערות:', entry.notes);
            if (newNotes === null) return;
            if (!isNaN(newAmount) && newAmount > 0) {
                entry.amount = newAmount;
                entry.notes = newNotes.trim();
                saveAllProjects();
                renderFinanceList();
            } else {
                alert('הסכום שהוזן אינו חוקי.');
            }
        }

        function deleteFinanceEntry(id) {
            if (confirm('האם אתה בטוח שברצונך למחוק תנועה כספית זו?')) {
                const initialLength = projects[currentProjectId].finance.length;
                projects[currentProjectId].finance = projects[currentProjectId].finance.filter(entry => entry.id !== id);
                if (projects[currentProjectId].finance.length < initialLength) {
                    saveAllProjects();
                    renderFinanceList();
                }
            }
        }

        function openCurrentProjectFinanceReportModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            currentProjectFinanceReportModal.style.display = 'flex';
            renderCurrentProjectFinanceReport();
        }

        function closeCurrentProjectFinanceReportModal() {
            currentProjectFinanceReportModal.style.display = 'none';
            showMainContent();
        }

        function renderCurrentProjectFinanceReport() {
            let totalIncome = 0;
            let totalExpense = 0;
            let totalBalance = 0;
            currentProjectFinanceReportTableBody.innerHTML = '';
            const sortedEntries = projects[currentProjectId].finance.slice().sort((a, b) => {
                const parseDateString = (ts) => {
                    const parts = ts.match(/(\d{2})\/(\d{2})\/(\d{4})(?:, (\d{2}):(\d{2}):(\d{2}))?/);
                    if (parts) {
                        const year = parseInt(parts[3], 10);
                        const month = parseInt(parts[2], 10) - 1;
                        const day = parseInt(parts[1], 10);
                        const hour = parseInt(parts[4] || 0, 10);
                        const minute = parseInt(parts[5] || 0, 10);
                        const second = parseInt(parts[6] || 0, 10);
                        return new Date(year, month, day, hour, minute, second);
                    }
                    return new Date(ts);
                };
                const dateA = parseDateString(a.timestamp);
                const dateB = parseDateString(b.timestamp);
                return dateA.getTime() - dateB.getTime(); // Oldest first for table
            });
            sortedEntries.forEach(entry => {
                const row = document.createElement('tr');
                const typeText = entry.type === 'income' ? 'הכנסה' : 'הוצאה';
                const amountText = entry.amount.toFixed(2) + ' ₪';
                row.innerHTML = `
                    <td>${entry.timestamp.split(',')[0]}</td>
                    <td>${typeText}</td>
                    <td>${amountText}</td>
                    <td>${entry.notes || 'אין הערות'}</td>
                `;
                currentProjectFinanceReportTableBody.appendChild(row);
                if (entry.type === 'income') {
                    totalIncome += entry.amount;
                } else {
                    totalExpense += entry.amount;
                }
            });
            totalBalance = totalIncome - totalExpense;
            currentProjectTotalIncomeDisplay.textContent = totalIncome.toFixed(2);
            currentProjectTotalExpenseDisplay.textContent = totalExpense.toFixed(2);
            currentProjectTotalBalanceDisplay.textContent = totalBalance.toFixed(2);
            currentProjectTotalBalanceDisplay.classList.remove('positive', 'negative');
            if (totalBalance > 0) {
                currentProjectTotalBalanceDisplay.classList.add('positive');
            } else if (totalBalance < 0) {
                currentProjectTotalBalanceDisplay.classList.add('negative');
            }
        }

        function openGlobalFinanceReportModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            globalFinanceReportModal.style.display = 'flex';
            renderGlobalFinanceReport();
        }

        function closeGlobalFinanceReportModal() {
            globalFinanceReportModal.style.display = 'none';
            showMainContent();
        }

        function renderGlobalFinanceReport() {
            let globalTotalIncome = 0;
            let globalTotalExpense = 0;
            let globalBalance = 0;
            globalFinanceProjectsDetails.innerHTML = '';
            const sortedProjectIds = Object.keys(projects).sort((a,b) => projects[a].name.localeCompare(projects[b].name));
            sortedProjectIds.forEach(projectId => {
                const project = projects[projectId];
                let projectIncome = 0;
                let projectExpense = 0;
                let projectBalance = 0;
                project.finance.forEach(entry => {
                    if (entry.type === 'income') {
                        projectIncome += entry.amount;
                    } else {
                        projectExpense += entry.amount;
                    }
                });
                projectBalance = projectIncome - projectExpense;
                globalTotalIncome += projectIncome;
                globalTotalExpense += projectExpense;
                globalBalance += projectBalance;
                const projectSection = document.createElement('div');
                projectSection.className = 'global-finance-project-section';
                projectSection.innerHTML = `
                    <h4>${project.name}</h4>
                    <p>הכנסות: <span style="color:#4CAF50;">${projectIncome.toFixed(2)}</span> ₪</p>
                    <p>הוצאות: <span style="color:#F44336;">${projectExpense.toFixed(2)}</span> ₪</p>
                    <p>יתרה: <span class="project-balance ${projectBalance >= 0 ? 'positive' : 'negative'}">${projectBalance.toFixed(2)}</span> ₪</p>
                `;
                globalFinanceProjectsDetails.appendChild(projectSection);
            });
            globalTotalIncomeDisplay.textContent = globalTotalIncome.toFixed(2);
            globalTotalExpenseDisplay.textContent = globalTotalExpense.toFixed(2);
            globalTotalBalanceDisplay.textContent = globalBalance.toFixed(2);
            globalTotalBalanceDisplay.classList.remove('positive', 'negative');
            if (globalBalance > 0) {
                globalTotalBalanceDisplay.classList.add('positive');
            } else if (globalBalance < 0) {
                globalTotalBalanceDisplay.classList.add('negative');
            }
        }

        function openFinanceYearlyModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            financeYearlyModal.style.display = 'flex';
            yearlyReportContent.style.display = 'none';
        }

        function closeFinanceYearlyModal() {
            financeYearlyModal.style.display = 'none';
            showMainContent();
        }

        function generateYearlyReport() {
            const selectedYear = yearSelect.value;
            if (!selectedYear) {
                alert('אנא בחר שנה.');
                return;
            }
            yearlyReportContent.style.display = 'block';
            let yearlyTotalIncome = 0;
            let yearlyTotalExpense = 0;
            let yearlyBalance = 0;
            yearlyFinanceProjectsDetails.innerHTML = '';
            const filteredProjects = Object.keys(projects).filter(projectId => {
                const project = projects[projectId];
                const vintageYearEntries = project.wineDetails.vintageYear;
                if (vintageYearEntries && vintageYearEntries.length > 0) {
                    const latestYear = vintageYearEntries[vintageYearEntries.length - 1].value;
                    return latestYear == selectedYear;
                }
                return false;
            });
            if (filteredProjects.length === 0) {
                yearlyFinanceProjectsDetails.innerHTML = '<p>אין פרויקטים בשנה זו.</p>';
                yearlyTotalIncomeDisplay.textContent = '0';
                yearlyTotalExpenseDisplay.textContent = '0';
                yearlyTotalBalanceDisplay.textContent = '0';
                return;
            }
            filteredProjects.forEach(projectId => {
                const project = projects[projectId];
                let projectIncome = 0;
                let projectExpense = 0;
                let projectBalance = 0;
                project.finance.forEach(entry => {
                    if (entry.type === 'income') {
                        projectIncome += entry.amount;
                    } else {
                        projectExpense += entry.amount;
                    }
                });
                projectBalance = projectIncome - projectExpense;
                yearlyTotalIncome += projectIncome;
                yearlyTotalExpense += projectExpense;
                yearlyBalance += projectBalance;
                const projectSection = document.createElement('div');
                projectSection.className = 'finance-yearly-project-section';
                projectSection.innerHTML = `
                    <h4>${project.name}</h4>
                    <p>הכנסות: <span style="color:#4CAF50;">${projectIncome.toFixed(2)}</span> ₪</p>
                    <p>הוצאות: <span style="color:#F44336;">${projectExpense.toFixed(2)}</span> ₪</p>
                    <p>יתרה: <span class="project-balance ${projectBalance >= 0 ? 'positive' : 'negative'}">${projectBalance.toFixed(2)}</span> ₪</p>
                `;
                yearlyFinanceProjectsDetails.appendChild(projectSection);
            });
            yearlyTotalIncomeDisplay.textContent = yearlyTotalIncome.toFixed(2);
            yearlyTotalExpenseDisplay.textContent = yearlyTotalExpense.toFixed(2);
            yearlyTotalBalanceDisplay.textContent = yearlyBalance.toFixed(2);
            yearlyTotalBalanceDisplay.classList.remove('positive', 'negative');
            if (yearlyBalance > 0) {
                yearlyTotalBalanceDisplay.classList.add('positive');
            } else if (yearlyBalance < 0) {
                yearlyTotalBalanceDisplay.classList.add('negative');
            }
        }

        function renderPreviousStageOverview() {
            stepCardsGrid.innerHTML = '';
            const stageOrder = Object.keys(stagesConfig).filter(id => id !== 'wineDetails');
            const currentStageIndex = stageOrder.indexOf(currentStageId);
            if (currentStageIndex === 0) {
                stageOverviewContainer.style.display = 'none';
                return;
            } else {
                stageOverviewContainer.style.display = 'block';
            }
            for (let i = 0; i < currentStageIndex; i++) {
                const prevStageId = stageOrder[i];
                const prevStageConfig = stagesConfig[prevStageId];
                const prevStageData = projects[currentProjectId].stages[prevStageId];
                const card = document.createElement('div');
                card.className = 'step-preview-card';
                card.onclick = () => switchStage(prevStageId);
                card.innerHTML = `<h5>${prevStageConfig.longName}</h5>`;
                if (prevStageConfig.summaryMetrics) {
                    prevStageConfig.summaryMetrics.forEach(metricId => {
                        const metricConfig = prevStageConfig.metrics[metricId];
                        const entries = prevStageData[metricId];
                        let displayValue = '--';
                        if (entries && entries.length > 0) {
                            displayValue = metricConfig.type === 'number'
                                ? entries[entries.length - 1].value.toFixed(metricConfig.precision)
                                : entries[entries.length - 1].value;
                        }
                        card.innerHTML += `<p>${metricConfig.name}: <span class="summary-value">${displayValue}</span></p>`;
                    });
                } else {
                     card.innerHTML += `<p>אין מדדי סיכום לשלב זה.</p>`;
                }
                stepCardsGrid.appendChild(card);
            }
        }

        function updateProjectDetailsCard() {
            const projectData = projects[currentProjectId];
            const wineDetailsData = projectData.wineDetails || {};
            const addCustomPropertyBtn = projectDetailsCard.querySelector('.add-custom-property-btn');
            projectDetailsCard.querySelectorAll('.project-details-item').forEach(item => {
                if (!item.classList.contains('custom-property')) {
                    item.remove();
                } else if (!addCustomPropertyBtn.contains(item)) {
                    item.remove();
                }
            });
            const predefinedMetrics = ['wineName', 'vintageYear', 'grapeVariety', 'vineyardSource', 'generalNotes', 'harvestDate'];
            predefinedMetrics.forEach(metricId => {
                const metricConfig = stagesConfig.wineDetails.metrics[metricId];
                const item = document.createElement('div');
                item.className = 'project-details-item';
                item.setAttribute('data-metric-id', metricId);
                item.setAttribute('data-section', 'wineDetails');
                item.innerHTML = `
                    <span class="detail-label">${metricConfig.name}:</span>
                    <span class="detail-value editable">--</span>
                `;
                projectDetailsCard.insertBefore(item, addCustomPropertyBtn);
                attachEditListenerToDetailItem(item);
            });
            const getLatestWineDetailValue = (metricId, precision = null) => {
                let entries;
                if (stagesConfig.wineDetails.metrics[metricId]) {
                    entries = wineDetailsData[metricId];
                } else {
                    const customProp = wineDetailsData.customProperties.find(prop => prop.id === metricId);
                    entries = customProp ? customProp.history : null;
                }
                if (entries && entries.length > 0) {
                    const value = entries[entries.length - 1].value;
                    return (typeof value === 'number' && precision !== null) ? value.toFixed(precision) : value;
                }
                return '--';
            };
            predefinedMetrics.forEach(metricId => {
                const item = projectDetailsCard.querySelector(`[data-metric-id="${metricId}"]`);
                if (item) {
                    const displaySpan = item.querySelector('.detail-value');
                    const metricConfig = stagesConfig.wineDetails.metrics[metricId];
                    const precision = metricConfig.type === 'number' ? metricConfig.precision : null;
                    displaySpan.textContent = getLatestWineDetailValue(metricId, precision);
                }
            });
            if (projectData.wineDetails.customProperties) {
                projectData.wineDetails.customProperties.forEach(prop => {
                    const customPropertyItem = document.createElement('div');
                    customPropertyItem.className = 'project-details-item custom-property';
                    customPropertyItem.setAttribute('data-metric-id', prop.id);
                    customPropertyItem.setAttribute('data-section', 'wineDetails');
                    customPropertyItem.innerHTML = `
                        <span class="detail-label">${prop.name}:</span>
                        <span class="detail-value editable">${getLatestWineDetailValue(prop.id)}</span>
                        <button class="delete-custom-prop-btn" onclick="deleteCustomProperty('${prop.id}')">מחק</button>
                    `;
                    projectDetailsCard.insertBefore(customPropertyItem, addCustomPropertyBtn);
                    attachEditListenerToDetailItem(customPropertyItem);
                });
            }
        }

        function addCustomProperty() {
            if (projects[currentProjectId].isClosed) {
                alert('הפרויקט סגור. פתח אותו כדי לערוך.');
                return;
            }
            const propName = prompt('הכנס שם לשדה המותאם אישית החדש:');
            if (propName && propName.trim() !== '') {
                const propId = `customProp_${Date.now()}`;
                const newCustomProperty = {
                    id: propId,
                    name: propName.trim(),
                    history: []
                };
                projects[currentProjectId].wineDetails.customProperties.push(newCustomProperty);
                saveAllProjects();
                updateProjectDetailsCard();
            }
        }

        function deleteCustomProperty(propId) {
            if (projects[currentProjectId].isClosed) {
                alert('הפרויקט סגור. פתח אותו כדי לערוך.');
                return;
            }
            if (confirm('האם אתה בטוח שברצונך למחוק שדה מותאם אישית זה?')) {
                projects[currentProjectId].wineDetails.customProperties = projects[currentProjectId].wineDetails.customProperties.filter(prop => prop.id !== propId);
                saveAllProjects();
                updateProjectDetailsCard();
            }
        }

        function attachEditListenerToDetailItem(item) {
            const displaySpan = item.querySelector('.detail-value');
            if (item._displaySpanClickHandler) {
                displaySpan.removeEventListener('click', item._displaySpanClickHandler);
            }
            const newClickHandler = () => {
                if (projects[currentProjectId].isClosed) {
                    alert('הפרויקט סגור. פתח אותו כדי לערוך.');
                    return;
                }
                if (currentEditableDetailElement && currentEditableDetailElement.displaySpan !== displaySpan) {
                    saveEditableDetail();
                }
                if (currentEditableDetailElement && currentEditableDetailElement.displaySpan === displaySpan) {
                    return;
                }
                const metricId = item.dataset.metricId;
                const section = item.dataset.section;
                let metricConfig;
                if (stagesConfig.wineDetails.metrics[metricId]) {
                    metricConfig = stagesConfig.wineDetails.metrics[metricId];
                } else {
                    const customProp = projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId);
                    metricConfig = { type: 'text', name: item.querySelector('.detail-label').textContent.replace(':', '') };
                    if (customProp && customProp.history.every(entry => typeof entry.value === 'number')) {
                        metricConfig.type = 'number';
                        metricConfig.step = 'any';
                        metricConfig.precision = 2;
                    }
                }
                currentEditableDetailElement = { item, metricId, section, metricConfig, displaySpan: displaySpan };
                let currentValue = displaySpan.textContent === '--' ? '' : displaySpan.textContent;
                let inputElement;
                if (metricConfig.type === 'date') {
                    showDatePicker(currentValue, (selectedDate) => {
                        updateProjectDetailValue(section, metricId, selectedDate);
                        displaySpan.style.display = 'block';
                        currentEditableDetailElement = null;
                    });
                    displaySpan.style.display = 'none';
                    return;
                } else if (metricConfig.type === 'select') {
                    inputElement = document.createElement('select');
                    inputElement.innerHTML = `<option value="" disabled>--בחר--</option>`;
                    if (metricConfig.options) {
                        metricConfig.options.forEach(option => {
                            const optionElem = document.createElement('option');
                            optionElem.value = option;
                            optionElem.textContent = option;
                            if (option === currentValue) {
                                optionElem.selected = true;
                            }
                            inputElement.appendChild(optionElem);
                        });
                    }
                    const otherOption = document.createElement('option');
                    otherOption.value = 'other_input_field';
                    otherOption.textContent = 'אחר...';
                    inputElement.appendChild(otherOption);
                    const otherInput = document.createElement('input');
                    otherInput.type = 'text';
                    otherInput.placeholder = 'הכנס ערך אחר';
                    otherInput.style.display = 'none';
                    otherInput.style.marginTop = '5px';
                    inputElement.addEventListener('change', () => {
                        if (inputElement.value === 'other_input_field') {
                            otherInput.style.display = 'block';
                            otherInput.focus();
                        } else {
                            otherInput.style.display = 'none';
                            otherInput.value = '';
                        }
                    });
                    if (currentValue && metricConfig.options && !metricConfig.options.includes(currentValue) && currentValue !== '--') {
                        inputElement.value = 'other_input_field';
                        otherInput.value = currentValue;
                        otherInput.style.display = 'block';
                    }
                    item.appendChild(inputElement);
                    item.appendChild(otherInput);
                    inputElement.focus();
                    currentEditableDetailElement.inputElement = inputElement;
                    currentEditableDetailElement.otherInput = otherInput;
                    inputElement.addEventListener('blur', saveEditableDetail);
                    otherInput.addEventListener('blur', saveEditableDetail);
                } else {
                    inputElement = document.createElement('input');
                    inputElement.type = metricConfig.type;
                    if (metricConfig.type === 'number') {
                        inputElement.step = metricConfig.step || 'any';
                    }
                    inputElement.value = currentValue;
                    inputElement.placeholder = metricConfig.placeholder || '';
                    item.appendChild(inputElement);
                    inputElement.focus();
                    inputElement.select();
                    currentEditableDetailElement.inputElement = inputElement;
                    inputElement.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            saveEditableDetail();
                        }
                    });
                    inputElement.addEventListener('blur', saveEditableDetail);
                }
                displaySpan.style.display = 'none';
            };
            displaySpan.addEventListener('click', newClickHandler);
            item._displaySpanClickHandler = newClickHandler;
        }

        function saveEditableDetail() {
            if (!currentEditableDetailElement) return;
            const { item, metricId, section, metricConfig, displaySpan, inputElement, otherInput } = currentEditableDetailElement;
            let newValue;
            if (metricConfig.type === 'select') {
                if (inputElement.value === 'other_input_field' && otherInput) {
                    newValue = otherInput.value.trim();
                } else {
                    newValue = inputElement.value;
                }
                if (otherInput) {
                    otherInput.remove();
                }
            } else {
                newValue = inputElement.value;
            }
            if (metricConfig.type === 'number') {
                newValue = parseFloat(newValue);
            }
            const oldValue = displaySpan.textContent === '--' ? '' : displaySpan.textContent;
            if (newValue !== oldValue && (metricConfig.type === 'number' ? !isNaN(newValue) : newValue !== "")) {
                updateProjectDetailValue(section, metricId, newValue);
            }
            if (inputElement) {
                inputElement.remove();
            }
            displaySpan.style.display = 'block';
            currentEditableDetailElement = null;
            updateProjectDetailsCard();
            if (section === currentStageId) {
                updateDashboardForCurrentStage();
            }
            renderPreviousStageOverview();
        }

        function updateProjectDetailValue(section, metricId, newValue) {
            let metricDataArray;
            if (section === 'wineDetails') {
                const predefinedMetricConfig = stagesConfig.wineDetails.metrics[metricId];
                if (predefinedMetricConfig) {
                    metricDataArray = projects[currentProjectId].wineDetails[metricId];
                } else {
                    const customProp = projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId);
                    if (customProp) {
                        metricDataArray = customProp.history;
                    } else {
                        console.error("Attempted to update non-existent custom property or metric:", metricId);
                        return;
                    }
                }
            } else {
                metricDataArray = projects[currentProjectId].stages[section][metricId];
            }
            const timestamp = new Date().toLocaleString('he-IL', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
            if (!metricDataArray) {
                console.error("Metric data array not found, initializing:", section, metricId);
                if (section === 'wineDetails') {
                    if (stagesConfig.wineDetails.metrics[metricId]) {
                        projects[currentProjectId].wineDetails[metricId] = [];
                    } else {
                        return;
                    }
                } else {
                    if (!projects[currentProjectId].stages[section]) projects[currentProjectId].stages[section] = {};
                    projects[currentProjectId].stages[section][metricId] = [];
                }
                metricDataArray = (section === 'wineDetails' ? projects[currentProjectId].wineDetails[metricId] : projects[currentProjectId].stages[section][metricId]);
            }
            if (metricDataArray.length > 0) {
                metricDataArray[metricDataArray.length - 1].value = newValue;
                metricDataArray[metricDataArray.length - 1].timestamp = timestamp;
            } else {
                metricDataArray.push({ value: newValue, timestamp: timestamp });
            }
            saveAllProjects();
            updateProjectDetailsCard();
            if (section === currentStageId) {
                updateDashboardForCurrentStage();
            }
            renderPreviousStageOverview();
        }

        function showDatePicker(initialDate, callback) {
            datePickerCallback = callback;
            datePickerModal.style.display = 'flex';
            let initialMonth, initialYear;
            if (initialDate && initialDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                const parts = initialDate.split('/');
                initialMonth = parseInt(parts[1], 10) - 1;
                initialYear = parseInt(parts[2], 10);
            } else {
                const today = new Date();
                initialMonth = today.getMonth();
                initialYear = today.getFullYear();
            }
            datePickerCurrentMonth = initialMonth;
            datePickerCurrentYear = initialYear;
            renderCalendar(datePickerCurrentMonth, datePickerCurrentYear);
            document.getElementById('prevMonthBtn').onclick = () => {
                datePickerCurrentMonth--;
                if (datePickerCurrentMonth < 0) {
                    datePickerCurrentMonth = 11;
                    datePickerCurrentYear--;
                }
                renderCalendar(datePickerCurrentMonth, datePickerCurrentYear);
            };
            document.getElementById('nextMonthBtn').onclick = () => {
                datePickerCurrentMonth++;
                if (datePickerCurrentMonth > 11) {
                    datePickerCurrentMonth = 0;
                    datePickerCurrentYear++;
                }
                renderCalendar(datePickerCurrentMonth, datePickerCurrentYear);
            };
        }

        function closeDatePickerModal() {
            datePickerModal.style.display = 'none';
            if (currentEditableDetailElement) {
                currentEditableDetailElement.displaySpan.style.display = 'block';
                if (currentEditableDetailElement.inputElement) {
                    currentEditableDetailElement.inputElement.remove();
                }
                if (currentEditableDetailElement.otherInput) {
                    currentEditableDetailElement.otherInput.remove();
                }
            }
            currentEditableDetailElement = null;
            datePickerCallback = null;
        }

        function renderCalendar(month, year) {
            datePickerGrid.innerHTML = `
                <div class="date-picker-day header">א</div>
                <div class="date-picker-day header">ב</div>
                <div class="date-picker-day header">ג</div>
                <div class="date-picker-day header">ד</div>
                <div class="date-picker-day header">ה</div>
                <div class="date-picker-day header">ו</div>
                <div class="date-picker-day header">ש</div>
            `;
            currentMonthYearDisplay.textContent = new Date(year, month).toLocaleString('he-IL', { month: 'long', year: 'numeric' });
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayIndex = firstDayOfMonth;
            for (let i = 0; i < startDayIndex; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('date-picker-day', 'empty');
                datePickerGrid.appendChild(dayDiv);
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('date-picker-day', 'current-month');
                dayDiv.textContent = day;
                dayDiv.onclick = () => selectDate(day, month, year);
                datePickerGrid.appendChild(dayDiv);
            }
        }

        function selectDate(day, month, year) {
            const selectedDate = `${String(day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`;
            if (datePickerCallback) {
                datePickerCallback(selectedDate);
            }
            closeDatePickerModal();
        }

        function openInstructionsModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            instructionsModal.style.display = 'flex';
        }

        function closeInstructionsModal() {
            instructionsModal.style.display = 'none';
            showMainContent();
        }

        function openTimelineModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            timelineModal.style.display = 'flex';
            renderTimeline();
        }

        function closeTimelineModal() {
            timelineModal.style.display = 'none';
            showMainContent();
        }

        function renderTimeline() {
            timelineContainer.innerHTML = '';
            let allEntries = [];
            const currentProject = projects[currentProjectId];
            for (const metricId in stagesConfig.wineDetails.metrics) {
                const metricConfig = stagesConfig.wineDetails.metrics[metricId];
                const entries = currentProject.wineDetails[metricId];
                if (entries && entries.length > 0) {
                    entries.forEach(entry => {
                        allEntries.push({
                            sectionName: stagesConfig.wineDetails.longName,
                            metricName: metricConfig.name,
                            value: entry.value,
                            timestamp: entry.timestamp,
                            rawTimestamp: new Date(entry.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:$6')),
                            color: '#8B0000'
                        });
                    });
                }
            }
            if (currentProject.wineDetails.customProperties) {
                currentProject.wineDetails.customProperties.forEach(prop => {
                    if (prop.history && prop.history.length > 0) {
                        prop.history.forEach(entry => {
                            allEntries.push({
                                sectionName: stagesConfig.wineDetails.longName,
                                metricName: prop.name,
                                value: entry.value,
                                timestamp: entry.timestamp,
                                rawTimestamp: new Date(entry.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:$6')),
                                color: '#A52A2A'
                            });
                        });
                    }
                });
            }
            for (const stageId in currentProject.stages) {
                const stageConfig = stagesConfig[stageId];
                if (!stageConfig || stageId === 'wineDetails') continue;
                const stageColor = stageConfig.emoji === '🟢' ? '#228B22' : stageConfig.emoji === '🍇' ? '#8B4513' : stageConfig.emoji === '🍷' ? '#B22222' : stageConfig.emoji === '🔁' ? '#FF6347' : stageConfig.emoji === '🛢' ? '#696969' : stageConfig.emoji === '🧪' ? '#4169E1' : '#8B0000';
                for (const metricId in stageConfig.metrics) {
                    const metricConfig = stageConfig.metrics[metricId];
                    const entries = currentProject.stages[stageId][metricId];
                    if (entries && entries.length > 0) {
                        entries.forEach(entry => {
                            allEntries.push({
                                sectionName: stageConfig.longName,
                                metricName: metricConfig.name,
                                value: entry.value,
                                timestamp: entry.timestamp,
                                rawTimestamp: new Date(entry.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:$6')),
                                color: stageColor
                            });
                        });
                    }
                }
            }
            allEntries.sort((a, b) => a.rawTimestamp - b.rawTimestamp);
            if (allEntries.length === 0) {
                timelineContainer.innerHTML = '<p style="text-align: center; color: var(--light-text-color);">אין נתונים זמינים עבור ציר הזמן בפרויקט זה.</p>';
                return;
            }
            allEntries.forEach((entry, index) => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'timeline-event';
                eventDiv.style.animationDelay = `${index * 0.1}s`;
                eventDiv.innerHTML = `
                    <div class="timeline-event-content" style="border-left: 5px solid ${entry.color};">
                        <h4 style="color: ${entry.color};">${entry.metricName} (${entry.sectionName})</h4>
                        <p>ערך: <span class="event-value">${entry.value}</span></p>
                        <span class="event-timestamp">${entry.timestamp}</span>
                    </div>
                `;
                timelineContainer.appendChild(eventDiv);
            });
        }

        function downloadTimelinePDF() {
            const entries = Array.from(timelineContainer.querySelectorAll('.timeline-event')).map((event, index) => {
                const title = event.querySelector('h4').textContent;
                const value = event.querySelector('.event-value').textContent;
                const timestamp = event.querySelector('.event-timestamp').textContent;
                return `${index + 1}. ${title}\nערך: ${value}\nתאריך: ${timestamp}`;
            });
            const docDefinition = {
                content: [
                    { text: 'ציר זמן - כל המדידות', style: 'header' },
                    { text: entries.join('\n\n'), style: 'text' }
                ],
                styles: {
                    header: { fontSize: 18, bold: true, alignment: 'right' },
                    text: { fontSize: 12, alignment: 'right' }
                }
            };
            pdfMake.createPdf(docDefinition).download('timeline.pdf');
        }

        function downloadCurrentProjectFinancePDF() {
            const docDefinition = {
                content: [
                    { text: 'דוח כספי - פרויקט נוכחי', style: 'header' },
                    { text: `סה"כ הכנסות: ${currentProjectTotalIncomeDisplay.textContent} ₪`, style: 'text' },
                    { text: `סה"כ הוצאות: ${currentProjectTotalExpenseDisplay.textContent} ₪`, style: 'text' },
                    { text: `יתרה נוכחית: ${currentProjectTotalBalanceDisplay.textContent} ₪`, style: 'text' },
                    { text: 'תנועות:', style: 'subheader' },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['*', '*', '*', '*'],
                            body: [
                                ['תאריך', 'סוג', 'סכום', 'הערות'],
                                ...Array.from(currentProjectFinanceReportTableBody.querySelectorAll('tr')).map(row => {
                                    const cells = row.querySelectorAll('td');
                                    return [cells[0].textContent, cells[1].textContent, cells[2].textContent, cells[3].textContent];
                                })
                            ]
                        }
                    }
                ],
                styles: {
                    header: { fontSize: 18, bold: true, alignment: 'right' },
                    subheader: { fontSize: 14, bold: true, alignment: 'right' },
                    text: { fontSize: 12, alignment: 'right' }
                }
            };
            pdfMake.createPdf(docDefinition).download('current_project_finance_report.pdf');
        }

        function downloadGlobalFinancePDF() {
            const docDefinition = {
                content: [
                    { text: 'דוח כספי כולל (כל הפרויקטים)', style: 'header' },
                    { text: `סה"כ הכנסות: ${globalTotalIncomeDisplay.textContent} ₪`, style: 'text' },
                    { text: `סה"כ הוצאות: ${globalTotalExpenseDisplay.textContent} ₪`, style: 'text' },
                    { text: `יתרה כוללת: ${globalTotalBalanceDisplay.textContent} ₪`, style: 'text' },
                    { text: 'פרויקטים:', style: 'subheader' },
                    ...Array.from(globalFinanceProjectsDetails.querySelectorAll('.global-finance-project-section')).map(section => {
                        const title = section.querySelector('h4').textContent;
                        const ps = Array.from(section.querySelectorAll('p')).map(p => p.textContent);
                        return { text: `${title}\n${ps.join('\n')}`, style: 'text' };
                    })
                ],
                styles: {
                    header: { fontSize: 18, bold: true, alignment: 'right' },
                    subheader: { fontSize: 14, bold: true, alignment: 'right' },
                    text: { fontSize: 12, alignment: 'right' }
                }
            };
            pdfMake.createPdf(docDefinition).download('global_finance_report.pdf');
        }

        function downloadYearlyFinancePDF() {
            const docDefinition = {
                content: [
                    { text: `דוח כספי לפי שנה - ${yearSelect.value}`, style: 'header' },
                    { text: `סה"כ הכנסות: ${yearlyTotalIncomeDisplay.textContent} ₪`, style: 'text' },
                    { text: `סה"כ הוצאות: ${yearlyTotalExpenseDisplay.textContent} ₪`, style: 'text' },
                    { text: `יתרה נוכחית: ${yearlyTotalBalanceDisplay.textContent} ₪`, style: 'text' },
                    { text: 'פרויקטים:', style: 'subheader' },
                    ...Array.from(yearlyFinanceProjectsDetails.querySelectorAll('.finance-yearly-project-section')).map(section => {
                        const title = section.querySelector('h4').textContent;
                        const ps = Array.from(section.querySelectorAll('p')).map(p => p.textContent);
                        return { text: `${title}\n${ps.join('\n')}`, style: 'text' };
                    })
                ],
                styles: {
                    header: { fontSize: 18, bold: true, alignment: 'right' },
                    subheader: { fontSize: 14, bold: true, alignment: 'right' },
                    text: { fontSize: 12, alignment: 'right' }
                }
            };
            pdfMake.createPdf(docDefinition).download(`yearly_finance_report_${yearSelect.value}.pdf`);
        }

        window.onclick = function(event) {
            if (event.target === historyModal) {
                closeHistoryModal();
            }
            if (event.target === projectManagementModal) {
                closeProjectManagementModal();
            }
            if (event.target === financeModal) {
                closeFinanceModal();
            }
            if (event.target === currentProjectFinanceReportModal) {
                closeCurrentProjectFinanceReportModal();
            }
            if (event.target === globalFinanceReportModal) {
                closeGlobalFinanceReportModal();
            }
            if (event.target === financeYearlyModal) {
                closeFinanceYearlyModal();
            }
            if (event.target === inboxModal) {
                closeInboxModal();
            }
            if (event.target === remindersModal) {
                closeRemindersModal();
            }
            if (event.target === instructionsModal) {
                closeInstructionsModal();
            }
            if (event.target === timelineModal) {
                closeTimelineModal();
            }
            if (event.target === datePickerModal && !event.target.closest('.date-picker-modal-content')) {
                closeDatePickerModal();
            }
            if (event.target === projectSelectionModal) {
                closeProjectSelectionModal();
            }
            if (event.target === sidebarOverlay) {
                closeSidebar();
            }
        }
    </script>
    <script>
        // בניית מצב האפליקציה לשמירה
        function getCurrentAppState() {
            return {
                projects: projects,
                currentProjectId: currentProjectId,
                currentStageId: currentStageId,
                darkMode: document.body.classList.contains('dark-mode'),
                savedAt: new Date().toISOString()
            };
        }

        // החלת מצב שהגיע מהענן על האפליקציה
        function applyStateToUI(state) {
            if (!state) return;

            // שחזור אובייקט projects וה‑IDs
            if (state.projects) {
                projects = state.projects;
            }
            if (state.currentProjectId && projects[state.currentProjectId]) {
                currentProjectId = state.currentProjectId;
                localStorage.setItem('currentProjectId', currentProjectId);
            }
            if (state.currentStageId && stagesConfig[state.currentStageId]) {
                currentStageId = state.currentStageId;
                localStorage.setItem('currentStageId', currentStageId);
            }

            // מצב כהה
            if (state.darkMode) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'true');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
            }

            // רענון ה‑UI לפי המצב החדש
            if (typeof renderAllMainContent === 'function') {
                renderAllMainContent();
            } else if (typeof updateProjectDisplay === 'function') {
                updateProjectDisplay();
            }
        }

        // שמירת מצב לענן (נקרא אחרי כל שינוי)
        async function saveStateToFirebase() {
            const user = auth.currentUser;
            if (!user) {
                // אם אין משתמש מחובר – נשארים רק עם localStorage
                console.log('לא מחובר – שומר רק בלוקאלי');
                localStorage.setItem('projects', JSON.stringify(projects));
                return;
            }

            const state = getCurrentAppState();

            try {
                await db.collection('wineMonitoringStates')
                    .doc(user.uid)
                    .set({
                        state,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                console.log('מצב נשמר בהצלחה בענן וגם ב‑localStorage');
                localStorage.setItem('projects', JSON.stringify(projects));
            } catch (err) {
                console.error('שגיאה בשמירה לפיירבייס:', err);
            }
        }

        // טעינת מצב מהענן כשמשתמש נכנס
        async function loadStateFromFirebase(user) {
            try {
                const docRef = db.collection('wineMonitoringStates').doc(user.uid);
                const docSnap = await docRef.get();

                if (!docSnap.exists) {
                    console.log('אין מצב שמור למשתמש – נשתמש ב‑localStorage');
                    // אם יש מצב בלוקאלי, נטען אותו
                    const localProjects = localStorage.getItem('projects');
                    if (localProjects) {
                        projects = JSON.parse(localProjects);
                        if (typeof renderAllMainContent === 'function') {
                            renderAllMainContent();
                        }
                    }
                    return;
                }

                const data = docSnap.data();
                applyStateToUI(data.state);
            } catch (err) {
                console.error('שגיאה בטעינת מצב מפיירבייס:', err);
            }
        }

        // התחברות/התנתקות עם גוגל
        window.addEventListener('load', () => {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const authStatus = document.getElementById('authStatus');

            const googleProvider = new firebase.auth.GoogleAuthProvider();

            if (loginBtn) {
                loginBtn.addEventListener('click', async () => {
                    try {
                        await auth.signInWithPopup(googleProvider);
                    } catch (err) {
                        console.error(err);
                        alert('שגיאה בהתחברות: ' + err.message);
                    }
                });
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    await auth.signOut();
                });
            }

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    if (authStatus) authStatus.textContent = 'מחובר כ: ' + (user.email || user.displayName || user.uid);
                    if (loginBtn) loginBtn.style.display = 'none';
                    if (logoutBtn) logoutBtn.style.display = 'inline-block';

                    await loadStateFromFirebase(user);
                } else {
                    if (authStatus) authStatus.textContent = 'לא מחובר';
                    if (loginBtn) loginBtn.style.display = 'inline-block';
                    if (logoutBtn) logoutBtn.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
