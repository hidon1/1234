<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>רשימת שורות בענן - Firebase</title>
  <style>
    :root { --gap: 0.6rem; font-family: system-ui, -apple-system, sans-serif; }
    body { padding: 2rem; direction: rtl; background: #fafafa; color:#111; }
    .wrap { max-width:700px; margin:0 auto; background:white; padding:1.2rem; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    h1 { margin:0 0 1rem 0; font-size:1.2rem; }
    .controls { display:flex; gap:var(--gap); margin-bottom: .75rem; align-items:center; }
    input[type="text"] { flex:1; padding:.6rem .8rem; font-size:1rem; border:1px solid #ddd; border-radius:8px; }
    button { padding:.55rem .75rem; border-radius:8px; border:1px solid #ccc; background:#f5f5f5; cursor:pointer; }
    button.primary { background:#2b7aee; color:white; border-color: #1f5fd6; }
    ul { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:.5rem; }
    li { display:flex; gap:.5rem; align-items:center; padding:.5rem; border-radius:8px; border:1px solid #eee; background: #fff; }
    .text { flex:1; word-break:break-word; padding-right:.25rem; }
    .meta { color:#666; font-size:.85rem; margin-left:.5rem; }
    .auth-box { margin-bottom: 1rem; padding: 1rem; border-bottom: 1px solid #eee; text-align: center; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div class="wrap">
    <div id="authSection" class="auth-box">
      <p id="userStatus">טוען...</p>
      <button id="loginBtn" class="primary hidden">התחבר עם Google</button>
      <button id="logoutBtn" class="hidden">התנתק</button>
    </div>

    <div id="mainApp" class="hidden">
      <h1>השורות שלי בענן</h1>
      <div class="controls">
        <input id="lineInput" type="text" placeholder="הקלד שורה חדשה..." />
        <button id="addBtn" class="primary">הוסף</button>
      </div>

      <ul id="list"></ul>
      <div id="empty" style="text-align:center; padding:1rem; color:#777;">אין שורות עדיין.</div>
      
      <div style="margin-top:1rem;">
        <button id="exportBtn">העתק הכל ללוח</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // הגדרות הפרויקט שלך
    const firebaseConfig = {
      apiKey: "AIzaSyB-yEX8EutF_Ds6sLaFSdToWRqnM2shUUc",
      authDomain: "project-124056294089354005.firebaseapp.com",
      projectId: "project-124056294089354005",
      storageBucket: "project-124056294089354005.firebasestorage.app",
      messagingSenderId: "566837476259",
      appId: "1:566837476259:web:c3fc8ea1943653fdd2b816"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let lines = [];
    let unsubscribe = null;

    // אלמנטים
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userStatus = document.getElementById('userStatus');
    const mainApp = document.getElementById('mainApp');
    const listEl = document.getElementById('list');
    const input = document.getElementById('lineInput');

    // ניהול מצב משתמש
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userStatus.textContent = `שלום, ${user.displayName}`;
        loginBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        mainApp.classList.remove('hidden');
        startListening(user.uid);
      } else {
        userStatus.textContent = "יש להתחבר כדי לשמור נתונים";
        loginBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        mainApp.classList.add('hidden');
        if (unsubscribe) unsubscribe();
        render([]);
      }
    });

    // כניסה ויציאה
    loginBtn.onclick = () => signInWithPopup(auth, provider);
    logoutBtn.onclick = () => signOut(auth);

    // האזנה לנתונים מ-Firestore
    function startListening(uid) {
      const q = query(
        collection(db, "lines"), 
        where("userId", "==", uid),
        orderBy("ts", "asc")
      );

      unsubscribe = onSnapshot(q, (snapshot) => {
        lines = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        render(lines);
      });
    }

    // הוספת שורה
    async function addLine() {
      const text = input.value.trim();
      if (!text || !auth.currentUser) return;
      
      await addDoc(collection(db, "lines"), {
        text: text,
        userId: auth.currentUser.uid,
        ts: Date.now()
      });
      input.value = '';
    }

    document.getElementById('addBtn').onclick = addLine;
    input.onkeydown = (e) => { if(e.key === 'Enter') addLine(); };

    // מחיקת שורה
    window.deleteLine = async (id) => {
      await deleteDoc(doc(db, "lines", id));
    };

    // רינדור רשימה
    function render(data) {
      listEl.innerHTML = '';
      document.getElementById('empty').style.display = data.length ? 'none' : 'block';
      
      data.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `
          <button onclick="deleteLine('${item.id}')">✖</button>
          <div class="text">${item.text}</div>
          <div class="meta">${new Date(item.ts).toLocaleTimeString('he-IL')}</div>
        `;
        listEl.appendChild(li);
      });
    }

    // העתקה
    document.getElementById('exportBtn').onclick = () => {
      const text = lines.map(l => l.text).join('\n');
      navigator.clipboard.writeText(text).then(() => alert('הועתק!'));
    };
  </script>
</body>
</html>
